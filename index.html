<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronFuel AI Diet Tracker</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¨­å®š Import Map ä»¥ä½¿ç”¨æ¨¡çµ„ (æ–°å¢ Recharts) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.10.3",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
      body { margin: 0; padding: 0; background-color: #0f172a; color: white; }
      
      /* èƒŒæ™¯åœ–å±¤è¨­å®š */
      #bg-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        background-image: url('./bg.jpg'); background-repeat: no-repeat;
        background-size: cover; background-position: center center; transition: all 0.5s ease;
      }
      /* æ‰‹æ©Ÿç‰ˆèƒŒæ™¯ç½®åº• */
      #bg-layer.mobile-fit {
        background-size: contain !important; background-position: bottom center !important; background-color: #0f172a; 
      }
      
      #root {
        background-color: rgba(15, 23, 42, 0.85); min-height: 100vh; width: 100%; position: relative; padding-bottom: 100px;
      }
      
      .loading { display: flex; justify-content: center; align-items: center; height: 100vh; color: #10b981; font-weight: bold; }
      
      /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* å‹•ç•« */
      @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); } 50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); } }
      .ai-glow { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>
    <div id="root"><div class="loading">æ­£åœ¨å•Ÿå‹• IronFuel...</div></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calculator, Camera, Utensils, BarChart3, ChevronRight, Plus, Trash2, Save, 
            Calendar as CalendarIcon, Loader2, TrendingDown, Target, Activity, ImagePlus, 
            FileText, Sparkles, ChefHat, MessageSquare, X, PenTool, Scale, MessageCircle, 
            Send, Bot, Key, LogOut, User, LogIn, Settings, Eye, EyeOff, CheckCircle2, 
            AlertTriangle, Copy, Database, Globe, Lock, ChevronDown, ChevronUp, Smartphone,
            Droplets, Flag, ArrowRight, Wand2, RefreshCcw, Trophy, ClipboardList, ScanLine, 
            Dumbbell
        } from 'lucide-react';
        import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            GoogleAuthProvider, signInWithPopup, signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, getDoc, addDoc, deleteDoc, 
            onSnapshot, query, orderBy, limit, Timestamp 
        } from 'firebase/firestore';

        // --- Firebase Config ---
        const manualConfig = {
            apiKey: "AIzaSyA9kVApSCs6eD-u5U90f3dnjbI9TILpaLQ",
            authDomain: "ironfuel-cd5bf.firebaseapp.com",
            projectId: "ironfuel-cd5bf",
            storageBucket: "ironfuel-cd5bf.firebasestorage.app",
            messagingSenderId: "690568494476",
            appId: "1:690568494476:web:5ecda02b96a59d5bc66aa9",
            measurementId: "G-9YS0R1FD5J"
        };

        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const appId = envAppId || 'ironfuel-app'; 
        const DEFAULT_GEMINI_MODEL = "gemini-1.5-flash";
        const DEFAULT_API_KEY = ""; 

        // --- åˆå§‹åŒ– Firebase ---
        let app, auth, db;
        try {
            let finalConfig = null;
            if (typeof __firebase_config !== 'undefined') {
                try { finalConfig = JSON.parse(__firebase_config); } catch (e) { console.error(e); }
            }
            if (!finalConfig && Object.keys(manualConfig).length > 0) {
                finalConfig = manualConfig;
            }
            if (finalConfig) {
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e); }

        // --- æ™ºæ…§é›™æ¨¡å¼•æ“ ---
        const callGeminiAPI = async (apiKey, contents) => {
            const tryFetch = async (model) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            };
            try { return await tryFetch("gemini-2.5-flash-preview-09-2025"); } 
            catch (e) { console.warn("Switching to 1.5 Flash...", e); return await tryFetch("gemini-1.5-flash"); }
        };

        // --- Helper Components ---
        const SimpleLineChart = ({ data, color = "#10b981", labelKey = "weight" }) => {
            if (!data || data.length < 2) return (<div className="h-40 flex items-center justify-center text-slate-500 text-xs border border-slate-700 border-dashed rounded-lg">è‡³å°‘éœ€è¦å…©ç­†è¨˜éŒ„æ‰èƒ½é¡¯ç¤ºè¶¨å‹¢åœ–</div>);
            const values = data.map(d => d[labelKey]);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((d[labelKey] - (min - range * 0.1)) / (range * 1.2)) * 100;
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="w-full h-40 relative mt-4">
                <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                    {data.map((d, i) => {
                        const x = (i / (data.length - 1)) * 100;
                        const y = 100 - ((d[labelKey] - (min - range * 0.1)) / (range * 1.2)) * 100;
                        return <circle key={i} cx={x} cy={y} r="2" fill="#1e293b" stroke={color} strokeWidth="1" vectorEffect="non-scaling-stroke" />;
                    })}
                </svg>
                <div className="absolute top-0 left-0 text-[10px] text-slate-500 -mt-5">{max}kg</div>
                <div className="absolute bottom-0 left-0 text-[10px] text-slate-500 -mb-5">{min}kg</div>
                </div>
            );
        };

        // --- Sub-Components Definitions (Missing ones restored here) ---
        
        const WaterTracker = ({ user, date }) => {
            const [water, setWater] = useState(0);
            const [target, setTarget] = useState(2500);
            useEffect(() => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'water_logs', date);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) { setWater(docSnap.data().amount || 0); if(docSnap.data().target) setTarget(docSnap.data().target); } else { setWater(0); }
                });
                return () => unsubscribe();
            }, [user, date]);
            const addWater = async (amount) => { const newAmount = Math.max(0, water + amount); await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'water_logs', date), { amount: newAmount, target: target, date: date }, { merge: true }); };
            const progress = Math.min(100, (water / target) * 100);
            return (<div className="bg-blue-900/30 border border-blue-500/30 p-4 rounded-2xl mb-6"><div className="flex justify-between items-center mb-3"><h3 className="text-blue-400 font-bold flex items-center gap-2"><Droplets className="w-5 h-5" /> å–æ°´ç´€éŒ„</h3><span className="text-xs text-blue-300">{water} / {target} ml</span></div><div className="w-full bg-slate-800 rounded-full h-4 mb-4 overflow-hidden relative"><div className="bg-blue-500 h-full transition-all duration-500 relative" style={{ width: `${progress}%` }}><div className="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div></div></div><div className="flex gap-3 justify-between"><button onClick={() => addWater(-250)} className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 text-xs font-mono">-250ml</button><button onClick={() => addWater(250)} className="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50 active:scale-95 transition-all"><Plus className="w-4 h-4" /> å–ä¸€æ¯ (250ml)</button></div></div>);
        };

        const PeriodizationPlanner = ({ profile }) => {
             const phases = [
                 { name: "é©æ‡‰æœŸ", duration: 4, focus: "å»ºç«‹ç¿’æ…£ã€æ¶ˆæ°´è…«", color: "text-emerald-400", border: "border-emerald-500/30" },
                 { name: "ç‡ƒè„‚æœŸ", duration: 4, focus: "æœ€å¤§åŒ–ç†±é‡èµ¤å­—ã€é‡è¨“ä¿è‚Œ", color: "text-blue-400", border: "border-blue-500/30" },
                 { name: "è¡åˆºæœŸ", duration: 4, focus: "é ‘å›ºè„‚è‚ªã€æœ€å¾Œä¿®é£¾", color: "text-purple-400", border: "border-purple-500/30" }
             ];
             return (<div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 mt-6"><h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Flag className="w-5 h-5 text-yellow-400" /> æ¸›è„‚é€±æœŸè¦åŠƒ</h2><div className="space-y-3">{phases.map((phase, idx) => { const startWeek = idx * 4 + 1; const endWeek = (idx + 1) * 4; return (<div key={idx} className={`p-3 rounded-xl bg-slate-900/50 border ${phase.border} flex justify-between items-center`}><div><div className={`font-bold text-sm ${phase.color}`}>{phase.name}</div><div className="text-[10px] text-slate-500">ç¬¬ {startWeek} - {endWeek} é€±</div></div><div className="text-right"><div className="text-xs text-slate-300">{phase.focus}</div></div></div>) })}</div><div className="mt-4 p-3 bg-slate-900 rounded-lg text-xs text-slate-400 border border-slate-800"><p>ğŸ’¡ å»ºè­°æ¯ 4 é€±é‡æ–°è©•ä¼°ä¸€æ¬¡ TDEE èˆ‡é«”é‡ã€‚</p></div></div>);
        };

        const DailyMotivation = ({ profile, apiKey }) => {
            const [quote, setQuote] = useState("");
            useEffect(() => {
                if (!apiKey || !profile) return;
                const fetchQuote = async () => {
                    const today = new Date().toDateString();
                    const saved = localStorage.getItem('ironfuel_quote');
                    if (saved) { const parsed = JSON.parse(saved); if (parsed.date === today) { setQuote(parsed.text); return; } }
                    try {
                        const prompt = `Give me a short, powerful fitness motivational quote in Traditional Chinese for someone whose goal is "${profile.goal}". Max 20 words.`;
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "å …æŒå°±æ˜¯å‹åˆ©ï¼";
                        setQuote(text);
                        localStorage.setItem('ironfuel_quote', JSON.stringify({ date: today, text }));
                    } catch (e) { setQuote("ä»Šå¤©ä¹Ÿè¦åŠ æ²¹ï¼Fuel your fight!"); }
                };
                fetchQuote();
            }, [apiKey, profile]);
            if (!quote) return null;
            return (<div className="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 border-l-4 border-emerald-500 rounded-r-xl shadow-lg animate-in slide-in-from-top-4"><p className="text-sm text-emerald-100 italic font-medium">â€œ{quote}â€</p></div>);
        };

        const InBodyScan = ({ user, apiKey }) => {
            const [scans, setScans] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [lastScanDate, setLastScanDate] = useState(null);
            const fileInputRef = useRef(null);
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs'), orderBy('date', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const logs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setScans(logs);
                    if (logs.length > 0) { setLastScanDate(logs[0].date); }
                });
                return () => unsubscribe();
            }, [user]);
            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!apiKey) { alert("AI åŠŸèƒ½æœªå•Ÿç”¨"); return; }
                setIsAnalyzing(true);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const prompt = `Analyze this InBody sheet image. Extract: Weight, Skeletal Muscle Mass (SMM), Percent Body Fat (PBF). Also provide a short, encouraging assessment in Traditional Chinese (max 50 words). Return JSON: { "weight": number, "smm": number, "pbf": number, "assessment": string }`;
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }]);
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonStr);
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs'), {
                            ...result, date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString()
                        });
                        setIsAnalyzing(false); alert("InBody åˆ†æå®Œæˆï¼");
                    };
                } catch (error) { console.error(error); alert("åˆ†æå¤±æ•—"); setIsAnalyzing(false); }
            };
            const deleteScan = async (id) => { if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs', id)); };
            let nextScanMsg = "å°šæœªæª¢æ¸¬", statusColor = "text-slate-400", daysLeft = 0;
            if (lastScanDate) {
                const last = new Date(lastScanDate); const next = new Date(last); next.setDate(last.getDate() + 30);
                daysLeft = Math.ceil((next - new Date()) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 0) { nextScanMsg = "âš ï¸ å·²éæœŸï¼è«‹å„˜å¿«æª¢æ¸¬"; statusColor = "text-red-400"; } else { nextScanMsg = `é‚„æœ‰ ${daysLeft} å¤©`; statusColor = "text-emerald-400"; }
            }
            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                        <div className="flex justify-between items-start mb-4"><div><h2 className="text-xl font-bold text-white flex items-center gap-2"><ScanLine className="w-5 h-5 text-blue-400" /> InBody è¿½è¹¤</h2><p className="text-xs text-slate-400 mt-1">å®šæœŸè¿½è¹¤èº«é«”çµ„æˆè®ŠåŒ–</p></div><div className="text-right"><p className="text-[10px] text-slate-500">ä¸‹æ¬¡æª¢æ¸¬</p><p className={`text-sm font-bold ${statusColor}`}>{nextScanMsg}</p></div></div>
                        <button onClick={() => fileInputRef.current.click()} disabled={isAnalyzing} className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all disabled:opacity-50">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <Camera className="w-5 h-5" />}{isAnalyzing ? "AI åˆ†æå ±å‘Šä¸­..." : "ä¸Šå‚³æœ¬æœˆå ±å‘Š (AI åˆ†æ)"}</button><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleUpload} />
                    </div>
                    <div className="space-y-4"><h3 className="text-white font-semibold text-sm ml-1">æ­·å²ç´€éŒ„</h3>{scans.length === 0 ? (<div className="text-center p-8 border-2 border-dashed border-slate-700 rounded-xl text-slate-500 text-xs">å°šç„¡ç´€éŒ„ï¼Œè«‹ä¸Šå‚³æ‚¨çš„ç¬¬ä¸€ä»½ InBody å ±å‘Šã€‚</div>) : (scans.map(scan => (<div key={scan.id} className="bg-slate-900/50 border border-slate-700 p-4 rounded-xl relative group"><div className="flex justify-between items-center mb-2"><span className="text-emerald-400 font-mono font-bold">{scan.date}</span><button onClick={() => deleteScan(scan.id)} className="text-slate-600 hover:text-red-400"><Trash2 className="w-4 h-4" /></button></div><div className="grid grid-cols-3 gap-2 mb-3 text-center"><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">é«”é‡</p><p className="text-white font-bold">{scan.weight}kg</p></div><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">éª¨éª¼è‚Œ</p><p className="text-blue-400 font-bold">{scan.smm}kg</p></div><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">é«”è„‚</p><p className="text-yellow-400 font-bold">{scan.pbf}%</p></div></div>{scan.assessment && (<div className="text-xs text-slate-300 bg-slate-800 p-3 rounded-lg italic border-l-2 border-blue-500">" {scan.assessment} "</div>)}</div>)))}</div>
                </div>
            );
        };

        // --- Main Screens ---
        const LoginScreen = ({ onGuestLogin, onGoogleLogin, isLoggingIn }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
            <div className="z-10 w-full max-w-md bg-slate-800/90 backdrop-blur-xl p-8 rounded-3xl border border-slate-700 shadow-2xl text-center">
                <div className="mb-8 flex flex-col items-center"><div className="bg-gradient-to-tr from-emerald-500 to-teal-500 p-4 rounded-2xl shadow-lg mb-4"><Activity className="w-10 h-10 text-white" /></div><h1 className="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">IronFuel</h1><p className="text-slate-400 mt-2 text-sm">æ‚¨çš„å°ˆå±¬ AI æ™ºèƒ½å¥èº«ç‡Ÿé¤Šæ•™ç·´</p></div>
                <div className="space-y-4">
                <button onClick={onGoogleLogin} disabled={isLoggingIn} className="w-full bg-white hover:bg-slate-100 text-slate-900 py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:scale-100">
                    {isLoggingIn ? <Loader2 className="w-5 h-5 animate-spin" /> : <span>Google å¸³è™Ÿç™»å…¥</span>}
                </button>
                <div className="relative flex items-center py-2"><div className="flex-grow border-t border-slate-600"></div><span className="flex-shrink-0 mx-4 text-slate-500 text-xs">æˆ–</span><div className="flex-grow border-t border-slate-600"></div></div>
                <button onClick={onGuestLogin} disabled={isLoggingIn} className="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95"><User className="w-5 h-5" />è¨ªå®¢è©¦ç”¨ (ä¸ä¿å­˜å¸³è™Ÿ)</button>
                </div>
                <p className="mt-8 text-xs text-slate-500">Fuel your fight, build your steel.</p>
            </div>
            </div>
        );

        const AIChatModal = ({ isOpen, onClose, profile, dayStats, apiKey }) => {
            const [messages, setMessages] = useState([{ role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å¥èº«æ•™ç·´ã€‚é—œæ–¼é£²é£Ÿã€è¨“ç·´æˆ–ç‡Ÿé¤Šï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ' }]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isOpen]);
            const handleSend = async () => {
                if (!input.trim()) return;
                const userMessage = { role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);
                const remaining = { cals: profile.targetCalories - dayStats.cals, pro: profile.protein - dayStats.pro, carbs: profile.carbs - dayStats.carbs, fat: profile.fats - dayStats.fat };
                try {
                    const contextPrompt = `System Context: You are "IronCoach". User Data: Goal: ${profile.goal}, Target: ${profile.targetCalories}kcal. Status: Consumed ${dayStats.cals}kcal. Remaining: ${remaining.cals}kcal. User Query: ${input}. Reply in Traditional Chinese.`;
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: contextPrompt }] }]);
                    setMessages(prev => [...prev, { role: 'model', text: data.candidates?.[0]?.content?.parts?.[0]?.text }]);
                } catch (error) { setMessages(prev => [...prev, { role: 'model', text: `é€£ç·šéŒ¯èª¤: ${error.message}` }]); } finally { setIsLoading(false); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4 animate-in fade-in duration-200">
                <div className="bg-slate-900 w-full max-w-md h-[80vh] rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center"><div className="flex items-center gap-2"><Bot className="w-5 h-5 text-white" /><h3 className="text-white font-bold">IronCoach</h3></div><button onClick={onClose}><X className="w-6 h-6 text-slate-400" /></button></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900">{messages.map((msg, idx) => (<div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-emerald-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-bl-none'}`}>{msg.text}</div></div>))}<div ref={messagesEndRef} /></div>
                    <div className="p-4 bg-slate-800 border-t border-slate-700"><div className="flex gap-2"><input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} className="flex-1 bg-slate-900 text-white p-3 rounded-xl border border-slate-700 outline-none" placeholder="å•å•æ•™ç·´..." /><button onClick={handleSend} disabled={isLoading} className="bg-emerald-600 text-white p-3 rounded-xl"><Send className="w-5 h-5" /></button></div></div>
                </div>
                </div>
            );
        };

        const SettingsScreen = ({ user, profile, setProfile, onSave, hasApiKey }) => {
            const [formData, setFormData] = useState(profile || { height: 171, weight: 80, age: 30, gender: 'male', activityLevel: '1.55', goal: 'cut', bodyFat: 21 });
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState("");
            const [showAdmin, setShowAdmin] = useState(false);
            const calculateTDEE = () => {
                let bmr = (10 * formData.weight) + (6.25 * formData.height) - (5 * formData.age);
                // é—œéµä¿®æ­£ï¼šåŠ å…¥æ€§åˆ¥åˆ¤æ–·
                bmr += formData.gender === 'male' ? 5 : -161;
                
                const tdee = Math.round(bmr * parseFloat(formData.activityLevel));
                let targetCalories = tdee;
                let protein = 0, carbs = 0, fats = 0;
                if (formData.goal === 'cut') { targetCalories = tdee - 500; protein = Math.round(formData.weight * 2.2); fats = Math.round(formData.weight * 0.9); } 
                else if (formData.goal === 'bulk') { targetCalories = tdee + 300; protein = Math.round(formData.weight * 2.0); fats = Math.round(formData.weight * 1.0); } 
                else { protein = Math.round(formData.weight * 1.8); fats = Math.round(formData.weight * 1.0); }
                const remainingCals = targetCalories - (protein * 4) - (fats * 9);
                carbs = Math.max(0, Math.round(remainingCals / 4));
                return { tdee, targetCalories, protein, carbs, fats };
            };
            const results = calculateTDEE();
            const handleSave = async () => {
                setIsSaving(true); setSaveMessage("");
                await onSave({ ...formData, ...results });
                setIsSaving(false); setSaveMessage("âœ… èº«é«”æ•¸æ“šå·²æ›´æ–°ï¼"); setTimeout(() => setSaveMessage(""), 3000);
            };
            const handleCopy = (text, label) => { navigator.clipboard.writeText(text); alert(`${label} å·²è¤‡è£½ï¼`); }
            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                <div className="flex items-center justify-between"><h2 className="text-xl font-bold text-emerald-400 flex items-center gap-2"><Activity className="w-5 h-5" /> èº«é«”æ•¸æ“šè¨­å®š</h2>{hasApiKey ? (<div className="flex items-center gap-1.5 px-3 py-1 bg-emerald-900/30 rounded-full border border-emerald-500/30"><div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div><span className="text-[10px] text-emerald-300 font-medium">AI å·²é€£ç·š</span></div>) : (<div className="flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full border border-slate-700"><div className="w-2 h-2 rounded-full bg-slate-500"></div><span className="text-[10px] text-slate-400 font-medium">AI é›¢ç·š</span></div>)}</div>
                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                    {/* æ–°å¢ï¼šæ€§åˆ¥é¸æ“‡ */}
                    <div className="mb-4">
                        <label className="text-slate-400 text-xs uppercase tracking-wider block mb-1">ç”Ÿç†æ€§åˆ¥ (å½±éŸ¿ TDEE è¨ˆç®—)</label>
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setFormData({...formData, gender: 'male'})}
                                className={`flex-1 py-3 rounded-lg font-bold transition-colors ${formData.gender === 'male' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                            >
                                ç”·æ€§ (Male)
                            </button>
                            <button 
                                onClick={() => setFormData({...formData, gender: 'female'})}
                                className={`flex-1 py-3 rounded-lg font-bold transition-colors ${formData.gender === 'female' ? 'bg-pink-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                            >
                                å¥³æ€§ (Female)
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div><label className="text-slate-400 text-xs block mb-1">èº«é«˜ (cm)</label><input type="number" value={formData.height} onChange={e => setFormData({...formData, height: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" /></div>
                        <div><label className="text-slate-400 text-xs block mb-1">é«”é‡ (kg)</label><input type="number" value={formData.weight} onChange={e => setFormData({...formData, weight: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" /></div>
                        <div><label className="text-slate-400 text-xs block mb-1">å¹´é½¡</label><input type="number" value={formData.age} onChange={e => setFormData({...formData, age: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" /></div>
                        <div><label className="text-slate-400 text-xs block mb-1">é«”è„‚ (%)</label><input type="number" value={formData.bodyFat} onChange={e => setFormData({...formData, bodyFat: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500" /></div>
                    </div>

                    <div className="mb-4">
                        <label className="text-slate-400 text-xs block mb-1">æ¯é€±é‹å‹•é‡</label>
                        <select value={formData.activityLevel} onChange={e => setFormData({...formData, activityLevel: e.target.value})} className="w-full bg-slate-700 text-white p-3 rounded-lg outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="1.2">ä¹…åä¸å‹• (è¾¦å…¬å®¤å·¥ä½œ)</option>
                            <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€± 1-3 å¤©)</option>
                            <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€± 3-5 å¤©)</option>
                            <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€± 6-7 å¤©)</option>
                        </select>
                    </div>

                    <div>
                        <label className="text-slate-400 text-xs block mb-1">ç›®å‰ç›®æ¨™</label>
                        <div className="flex gap-2">
                            <button onClick={() => setFormData({...formData, goal: 'cut'})} className={`flex-1 py-3 rounded-lg font-bold transition-colors ${formData.goal === 'cut' ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'}`}>æ¸›è„‚</button>
                            <button onClick={() => setFormData({...formData, goal: 'maintain'})} className={`flex-1 py-3 rounded-lg font-bold transition-colors ${formData.goal === 'maintain' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>ç¶­æŒ</button>
                            <button onClick={() => setFormData({...formData, goal: 'bulk'})} className={`flex-1 py-3 rounded-lg font-bold transition-colors ${formData.goal === 'bulk' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-400'}`}>å¢è‚Œ</button>
                        </div>
                    </div>
                </div>

                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-10"><Target className="w-24 h-24 text-emerald-400" /></div>
                    <h3 className="text-lg font-semibold text-white mb-4">é è¦½ï¼šæ¯æ—¥ç‡Ÿé¤Šç›®æ¨™</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">ç†±é‡</p><p className="text-2xl font-bold text-emerald-400">{results.targetCalories}</p><p className="text-xs text-slate-500">kcal</p></div>
                        <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">è›‹ç™½</p><p className="text-xl font-bold text-blue-400">{results.protein}g</p></div>
                        <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">ç¢³æ°´</p><p className="text-xl font-bold text-yellow-400">{results.carbs}g</p></div>
                        <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">è„‚è‚ª</p><p className="text-xl font-bold text-red-400">{results.fats}g</p></div>
                    </div>
                    <button onClick={handleSave} disabled={isSaving} className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-900/20">{isSaving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}{isSaving ? "æ­£åœ¨å„²å­˜..." : "å„²å­˜ä¸¦æ›´æ–°ç›®æ¨™"}</button>
                    {saveMessage && <div className="mt-3 p-3 bg-emerald-500/20 border border-emerald-500/50 rounded-lg flex items-center gap-2 text-emerald-400 text-sm justify-center animate-in fade-in slide-in-from-bottom-2"><CheckCircle2 className="w-4 h-4" /> {saveMessage}</div>}
                </div>
                
                <PeriodizationPlanner profile={profile} />
                
                <div className="pt-8 border-t border-slate-800/50 text-center">
                    <button onClick={() => setShowAdmin(!showAdmin)} className="text-[10px] text-slate-700 hover:text-slate-500 transition-colors flex items-center justify-center gap-1 mx-auto">{showAdmin ? <ChevronUp className="w-3 h-3" /> : <Lock className="w-3 h-3" />}{showAdmin ? "éš±è—ç®¡ç†" : "ç®¡ç†å“¡è¨­ç½®"}</button>
                    {showAdmin && (<div className="mt-6 text-left bg-slate-900 p-4 rounded-xl border border-slate-700 animate-in slide-in-from-bottom-4"><div className="flex items-center gap-2 mb-3 text-yellow-500"><Database className="w-4 h-4" /><span className="font-bold text-sm">Firebase é€£ç·šè³‡è¨Š</span></div><div className="text-xs text-slate-500 mb-4 space-y-2"><p>API Key è·¯å¾‘:</p><div className="bg-black/30 p-2 rounded font-mono text-emerald-400 break-all">artifacts / {appId} / public / data / config / settings</div></div><div className="space-y-2"><div><label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">App ID</label><div className="flex gap-2 mt-1"><code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">{appId}</code><button onClick={() => handleCopy(appId)} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button></div></div><div><label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">User ID</label><div className="flex gap-2 mt-1"><code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">{user.uid}</code><button onClick={() => handleCopy(user.uid)} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button></div></div></div></div>)}
                </div>
                </div>
            );
        };

        const FoodDiary = ({ user, profile, apiKey }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [logs, setLogs] = useState([]);
            const [isManualOpen, setIsManualOpen] = useState(false);
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [manualData, setManualData] = useState({ name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: '' });
            const [aiHint, setAiHint] = useState("");
            const [smartText, setSmartText] = useState("");
            const [isSmartParsing, setIsSmartParsing] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isSuggesting, setIsSuggesting] = useState(false);
            const [suggestion, setSuggestion] = useState(null);
            const fileInputRef = useRef(null);
            const [dayStats, setDayStats] = useState({ cals: 0, pro: 0, carbs: 0, fat: 0 });

            useEffect(() => {
                if (!user) return;
                return onSnapshot(query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs')), (snapshot) => {
                    const allLogs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const todaysLogs = allLogs.filter(log => log.date === date);
                    setLogs(todaysLogs);
                    setDayStats(todaysLogs.reduce((acc, curr) => ({
                        cals: acc.cals + (curr.calories || 0), pro: acc.pro + (curr.protein || 0), carbs: acc.carbs + (curr.carbs || 0), fat: acc.fat + (curr.fat || 0)
                    }), { cals: 0, pro: 0, carbs: 0, fat: 0 }));
                });
            }, [user, date]);

            const handleManualSubmit = async () => {
                if (!manualData.name || !manualData.calories) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), { ...manualData, calories: Number(manualData.calories), protein: Number(manualData.protein), carbs: Number(manualData.carbs), fat: Number(manualData.fat), date, timestamp: new Date().toISOString() });
                setIsManualOpen(false); setManualData({ name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: '' }); setSmartText("");
            };

            const handleSmartTextAnalysis = async () => {
                if (!smartText.trim() || !apiKey) return alert("è«‹è¼¸å…¥æ–‡å­—æˆ–æª¢æŸ¥ AI è¨­å®š");
                setIsSmartParsing(true);
                try {
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: `Parse food text: "${smartText}" to JSON {name, calories, protein, carbs, fat}. Use Traditional Chinese.` }] }]);
                    const parsed = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                    setManualData({ ...manualData, ...parsed });
                } catch (e) { alert("åˆ†æå¤±æ•—"); } finally { setIsSmartParsing(false); }
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return;
                setIsAnalyzing(true); setIsCameraOpen(false);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: `${aiHint} Analyze food image to JSON {name, calories, protein, carbs, fat}.` }, { inlineData: { mimeType: file.type, data: base64Data } }] }]);
                        const parsed = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                        setManualData({ ...manualData, ...parsed }); setIsManualOpen(true);
                    };
                } catch (e) { alert("åˆ†æå¤±æ•—"); } finally { setIsAnalyzing(false); }
            };
            const deleteLog = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'logs', id)); };
            const getMealSuggestion = async () => {
                if (!apiKey) { alert("AI åŠŸèƒ½å°šæœªå•Ÿç”¨"); return; }
                setIsSuggesting(true); setSuggestion(null);
                const remaining = { cals: profile.targetCalories - dayStats.cals, pro: profile.protein - dayStats.pro, carbs: profile.carbs - dayStats.carbs, fat: profile.fats - dayStats.fat };
                try {
                    const prompt = `æˆ‘æ˜¯å¥èº«æ•™ç·´ã€‚å­¸ç”Ÿå‰©ä¸‹é¡åº¦ï¼šç†±é‡ ${remaining.cals}kcal, è›‹ ${remaining.pro}g, ç¢³ ${remaining.carbs}g, è„‚ ${remaining.fat}gã€‚ç›®æ¨™ï¼š${profile.goal}ã€‚è«‹å»ºè­°ä¸€é¤ï¼Œç¹é«”ä¸­æ–‡ã€‚å›å‚³ JSON: { "mealName": "åç¨±", "reason": "ç†ç”±", "ingredients": "é£Ÿæ", "estimatedNutrition": "é ä¼°ç‡Ÿé¤Š" }`;
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                    const jsonStr = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    setSuggestion(JSON.parse(jsonStr));
                } catch (error) { alert("AI æ€è€ƒè¶…æ™‚"); } finally { setIsSuggesting(false); }
            };
            const Progress = ({ current, target, color }) => { const pct = Math.min((current / target) * 100, 100); return <div className="w-full bg-slate-700 rounded-full h-2 mt-1"><div className={`h-2 rounded-full ${color} transition-all duration-500`} style={{ width: `${pct}%` }} /></div>; };

            return (
                <div className="space-y-6">
                    <DailyMotivation profile={profile} apiKey={apiKey} />
                    <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() - 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5 rotate-180" /></button>
                        <div className="flex items-center gap-2 font-bold"><CalendarIcon className="w-5 h-5 text-emerald-500" />{date}</div>
                        <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() + 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5" /></button>
                    </div>
                    <WaterTracker user={user} date={date} />
                    
                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                        <div className="flex justify-between mb-4"><div><h3 className="text-slate-400 text-sm">ç†±é‡</h3><div className="flex items-baseline gap-2"><span className="text-3xl font-bold">{Math.round(dayStats.cals)}</span><span className="text-sm text-slate-500">/{profile?.targetCalories}</span></div></div><div className={`text-right text-sm font-bold ${profile?.targetCalories - dayStats.cals >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{profile?.targetCalories - dayStats.cals >= 0 ? 'å‰©' : 'è¶…'} {Math.abs(Math.round(profile?.targetCalories - dayStats.cals))}</div></div>
                        <Progress current={dayStats.cals} target={profile?.targetCalories} color="bg-emerald-500" />
                        <div className="grid grid-cols-3 gap-4 mt-6 text-center">
                            <div><p className="text-xs text-slate-400 mb-1">è›‹ç™½è³ª</p><p className="text-lg font-bold text-blue-400">{dayStats.pro.toFixed(1)}g</p><div className="text-[10px] flex justify-center gap-2 mb-1"><span className="text-slate-500">ç›®æ¨™ {profile?.protein}</span><span className={profile?.protein - dayStats.pro >= 0 ? "text-slate-400" : "text-red-400"}>{profile?.protein - dayStats.pro >= 0 ? "å‰©" : "è¶…"} {Math.abs(profile?.protein - dayStats.pro).toFixed(1)}</span></div><Progress current={dayStats.pro} target={profile?.protein} color="bg-blue-500" /></div>
                            <div><p className="text-xs text-slate-400 mb-1">ç¢³æ°´</p><p className="text-lg font-bold text-yellow-400">{dayStats.carbs.toFixed(1)}g</p><div className="text-[10px] flex justify-center gap-2 mb-1"><span className="text-slate-500">ç›®æ¨™ {profile?.carbs}</span><span className={profile?.carbs - dayStats.carbs >= 0 ? "text-slate-400" : "text-red-400"}>{profile?.carbs - dayStats.carbs >= 0 ? "å‰©" : "è¶…"} {Math.abs(profile?.carbs - dayStats.carbs).toFixed(1)}</span></div><Progress current={dayStats.carbs} target={profile?.carbs} color="bg-yellow-500" /></div>
                            <div><p className="text-xs text-slate-400 mb-1">è„‚è‚ª</p><p className="text-lg font-bold text-red-400">{dayStats.fat.toFixed(1)}g</p><div className="text-[10px] flex justify-center gap-2 mb-1"><span className="text-slate-500">ç›®æ¨™ {profile?.fats}</span><span className={profile?.fats - dayStats.fat >= 0 ? "text-slate-400" : "text-red-400"}>{profile?.fats - dayStats.fat >= 0 ? "å‰©" : "è¶…"} {Math.abs(profile?.fats - dayStats.fat).toFixed(1)}</span></div><Progress current={dayStats.fat} target={profile?.fats} color="bg-red-500" /></div>
                        </div>
                    </div>
                    {suggestion && (<div className="bg-gradient-to-br from-indigo-900 to-slate-900 p-5 rounded-2xl border border-indigo-500/50 relative animate-in slide-in-from-top-4"><button onClick={() => setSuggestion(null)} className="absolute top-3 right-3 text-slate-400 hover:text-white"><X className="w-5 h-5" /></button><div className="flex items-center gap-2 mb-3"><Sparkles className="w-5 h-5 text-indigo-400" /><h3 className="font-bold text-white">AI æ™ºèƒ½é¤é»å»ºè­°</h3></div><h4 className="text-xl font-bold text-indigo-300 mb-2">{suggestion.mealName}</h4><p className="text-slate-300 text-sm mb-3">{suggestion.reason}</p><div className="bg-black/30 p-3 rounded-lg text-sm text-slate-300 mb-3"><strong>å»ºè­°é£Ÿæï¼š</strong> {suggestion.ingredients}</div><div className="text-xs text-indigo-400 font-mono">{suggestion.estimatedNutrition}</div></div>)}
                    {/* ... (æ‰‹å‹•è¼¸å…¥èˆ‡æŒ‰éˆ•å€ä¿æŒä¸è®Š) ... */}
                    {isManualOpen && (<div className="bg-slate-800 p-5 rounded-2xl border border-slate-600 animate-in slide-in-from-top-2"><div className="flex justify-between items-center mb-4"><h3 className="text-white font-bold flex items-center gap-2"><PenTool className="w-5 h-5 text-emerald-400" /> {manualData.name ? 'ç¢ºèªä¸¦ç·¨è¼¯é¤é»' : 'æ–°å¢é¤é»'}</h3><button onClick={() => setIsManualOpen(false)} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button></div><div className="bg-slate-900/50 p-3 rounded-xl mb-4 border border-slate-700"><label className="text-xs text-emerald-400 block mb-2 flex items-center gap-1"><Sparkles className="w-3 h-3" /> AI é€Ÿè¨˜</label><div className="flex gap-2"><input type="text" placeholder="è¼¸å…¥é£Ÿç‰©æè¿°..." className="flex-1 bg-slate-950 text-white p-2 rounded-lg border border-slate-600 text-sm" value={smartText} onChange={(e) => setSmartText(e.target.value)} /><button onClick={handleSmartTextAnalysis} disabled={isSmartParsing} className="bg-emerald-600 px-3 rounded-lg">{isSmartParsing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Wand2 className="w-4 h-4" />}</button></div></div><div className="space-y-3"><input type="text" placeholder="åç¨±" className="w-full bg-slate-900 p-3 rounded-lg" value={manualData.name} onChange={e => setManualData({...manualData, name: e.target.value})} /><div className="grid grid-cols-2 gap-2"><input type="number" placeholder="ç†±é‡" className="bg-slate-900 p-3 rounded-lg" value={manualData.calories} onChange={e => setManualData({...manualData, calories: e.target.value})} /><select className="bg-slate-900 p-3 rounded-lg" value={manualData.mealType} onChange={e => setManualData({...manualData, mealType: e.target.value})}><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option><option value="snack">é»å¿ƒ</option></select></div><div className="grid grid-cols-3 gap-2"><input type="number" placeholder="è›‹ç™½" className="bg-slate-900 p-3 rounded-lg" value={manualData.protein} onChange={e => setManualData({...manualData, protein: e.target.value})} /><input type="number" placeholder="ç¢³æ°´" className="bg-slate-900 p-3 rounded-lg" value={manualData.carbs} onChange={e => setManualData({...manualData, carbs: e.target.value})} /><input type="number" placeholder="è„‚è‚ª" className="bg-slate-900 p-3 rounded-lg" value={manualData.fat} onChange={e => setManualData({...manualData, fat: e.target.value})} /></div><button onClick={handleManualSubmit} className="w-full bg-emerald-600 py-3 rounded-lg font-bold">ç¢ºèªåŠ å…¥</button></div></div>)}
                    {!isManualOpen && !isCameraOpen && (<div className="grid grid-cols-3 gap-2"><button onClick={() => setIsManualOpen(true)} className="bg-slate-700 py-4 rounded-xl flex flex-col items-center"><PenTool className="text-emerald-400 mb-1" /><span className="text-xs">æ‰‹å‹•</span></button><button onClick={() => setIsCameraOpen(true)} disabled={isAnalyzing} className="bg-slate-700 py-4 rounded-xl flex flex-col items-center">{isAnalyzing ? <Loader2 className="animate-spin text-blue-400 mb-1" /> : <Camera className="text-blue-400 mb-1" />}<span className="text-xs">æ‹ç…§</span></button><button onClick={getMealSuggestion} disabled={isSuggesting} className="bg-gradient-to-br from-indigo-600 to-purple-700 py-4 rounded-xl flex flex-col items-center"><ChefHat className="text-yellow-300 mb-1" /><span className="text-xs">å»ºè­°</span></button></div>)}
                    {isCameraOpen && (<div className="bg-slate-800 p-4 rounded-xl border border-blue-500"><div className="flex justify-between mb-2"><h4 className="font-bold text-blue-400">AI è¾¨è­˜</h4><button onClick={() => setIsCameraOpen(false)}><X /></button></div><input type="text" value={aiHint} onChange={e => setAiHint(e.target.value)} placeholder="æç¤º (é¸å¡«)..." className="w-full bg-slate-900 p-2 rounded mb-3" /><button onClick={() => fileInputRef.current.click()} className="w-full bg-blue-600 py-3 rounded-lg font-bold flex justify-center gap-2"><Camera /> é¸æ“‡ç…§ç‰‡</button><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /></div>)}
                    <div className="space-y-3 pb-20">{logs.map(log => (<div key={log.id} className="bg-slate-800 p-4 rounded-xl flex justify-between items-center border border-slate-700"><div><div className="font-bold">{log.name}</div><div className="text-xs text-slate-400">{Math.round(log.calories)} kcal | P:{Number(log.protein).toFixed(1)} C:{Number(log.carbs).toFixed(1)} F:{Number(log.fat).toFixed(1)}</div></div><button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'logs', log.id))}><Trash2 className="text-slate-600" /></button></div>))}</div>
                </div>
            );
        };

        const Reports = ({ user, profile, apiKey }) => {
            const [reportData, setReportData] = useState([]);
            const [average, setAverage] = useState({ cals: 0, pro: 0 });
            const [analysis, setAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [weightLogs, setWeightLogs] = useState([]);
            const [currentWeight, setCurrentWeight] = useState("");
            const [cycleStats, setCycleStats] = useState(null);

            useEffect(() => {
                if(!user) return;
                const qLogs = query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), orderBy('date', 'desc'));
                const unsubscribeLogs = onSnapshot(qLogs, (snapshot) => {
                    const allLogs = snapshot.docs.map(d => d.data());
                    const grouped = allLogs.reduce((acc, curr) => {
                        if (!acc[curr.date]) { acc[curr.date] = { date: curr.date, cals: 0, pro: 0, carbs: 0, fat: 0 }; }
                        acc[curr.date].cals += (curr.calories || 0);
                        acc[curr.date].pro += (curr.protein || 0);
                        acc[curr.date].carbs += (curr.carbs || 0);
                        acc[curr.date].fat += (curr.fat || 0);
                        return acc;
                    }, {});
                    const sortedDays = Object.values(grouped)
                        .sort((a, b) => new Date(a.date) - new Date(b.date))
                        .slice(-7);
                    setReportData(sortedDays);
                    if (sortedDays.length > 0) {
                        const totalCals = sortedDays.reduce((sum, d) => sum + d.cals, 0);
                        const totalPro = sortedDays.reduce((sum, d) => sum + d.pro, 0);
                        setAverage({ cals: Math.round(totalCals / sortedDays.length), pro: Math.round(totalPro / sortedDays.length) });
                    }
                });
                const qWeight = query(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), orderBy('date', 'asc'));
                const unsubscribeWeight = onSnapshot(qWeight, (snapshot) => { 
                    const wLogs = snapshot.docs.map(d => ({ ...d.data(), dateShort: d.data().date.substring(5) })); 
                    setWeightLogs(wLogs); 
                    if (wLogs.length > 0) {
                        const sortedWeights = [...wLogs];
                        const latest = sortedWeights[sortedWeights.length - 1];
                        const today = new Date();
                        const fourWeeksAgoDate = new Date();
                        fourWeeksAgoDate.setDate(today.getDate() - 28);
                        const fourWeeksAgoStr = fourWeeksAgoDate.toISOString().split('T')[0];
                        const startLog = sortedWeights.find(w => w.date >= fourWeeksAgoStr) || sortedWeights[0];
                        const daysDiff = Math.floor((new Date(latest.date) - new Date(startLog.date)) / (1000 * 60 * 60 * 24));
                        const cycleDay = Math.min(28, Math.max(1, daysDiff)); 
                        setCycleStats({
                            startWeight: startLog.weight,
                            currentWeight: latest.weight,
                            change: (latest.weight - startLog.weight).toFixed(1),
                            daysInCycle: cycleDay
                        });
                    }
                });
                return () => { unsubscribeLogs(); unsubscribeWeight(); };
            }, [user]);

            const handleAddWeight = async () => {
                if (!currentWeight) return;
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), { date: today, weight: Number(currentWeight), timestamp: new Date().toISOString() });
                setCurrentWeight("");
            };

            const handleAnalyze = async () => {
                if (reportData.length === 0) return;
                if (!apiKey) { alert("AI åŠŸèƒ½å°šæœªå•Ÿç”¨"); return; }
                setIsAnalyzing(true);
                setAnalysis("");
                try {
                    const prompt = `åˆ†æé€™7å¤©æ•¸æ“šï¼š${JSON.stringify(reportData)}ã€‚é«”é‡ç´€éŒ„ï¼š${JSON.stringify(weightLogs.slice(-5))}ã€‚ç›®æ¨™ï¼š${profile.goal}ã€‚ç¹é«”ä¸­æ–‡å›è¦†ã€‚`;
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                    setAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { alert("åˆ†æå¤±æ•—"); } finally { setIsAnalyzing(false); }
            };

            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Scale className="w-5 h-5 text-emerald-400" /> é«”é‡è¿½è¹¤</h2>
                        <div className="flex gap-2 mb-4">
                            <input type="number" placeholder="ä»Šæ—¥é«”é‡ (kg)" className="flex-1 bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={currentWeight} onChange={(e) => setCurrentWeight(e.target.value)} />
                            <button onClick={handleAddWeight} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded-lg font-bold">è¨˜éŒ„</button>
                        </div>
                        <div className="bg-slate-900/50 p-2 rounded-xl border border-slate-800 h-64 w-full">
                            {weightLogs.length > 1 ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={weightLogs}>
                                        <defs>
                                            <linearGradient id="colorWeight" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/>
                                                <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <XAxis dataKey="dateShort" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
                                        <YAxis domain={['dataMin - 1', 'dataMax + 1']} stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} width={30} />
                                        <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff' }} />
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                        <Area type="monotone" dataKey="weight" stroke="#10b981" strokeWidth={2} fillOpacity={1} fill="url(#colorWeight)" />
                                    </AreaChart>
                                </ResponsiveContainer>
                            ) : (
                                <div className="flex h-full items-center justify-center text-slate-500 text-sm">è«‹è‡³å°‘è¼¸å…¥å…©ç­†é«”é‡ä»¥é¡¯ç¤ºåœ–è¡¨</div>
                            )}
                        </div>
                    </div>

                    {cycleStats && (
                        <div className="bg-gradient-to-br from-slate-800 to-indigo-900 p-6 rounded-2xl border border-indigo-500/30 shadow-xl">
                            <div className="flex justify-between items-start mb-4">
                                <div><h3 className="text-lg font-bold text-white flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-400" /> 4é€±æˆ°æƒ…å®¤</h3><p className="text-xs text-indigo-200 mt-1">ç¬¬ {cycleStats.daysInCycle} / 28 å¤©</p></div>
                                <div className={`text-2xl font-bold ${cycleStats.change <= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{cycleStats.change > 0 ? '+' : ''}{cycleStats.change} <span className="text-sm">kg</span></div>
                            </div>
                            <div className="w-full bg-slate-900 rounded-full h-2 mb-4"><div className="bg-indigo-500 h-2 rounded-full transition-all duration-1000" style={{ width: `${(cycleStats.daysInCycle / 28) * 100}%` }}></div></div>
                            <div className="flex justify-between text-xs text-slate-400 bg-black/20 p-3 rounded-lg">
                                <div className="text-center"><p>èµ·é»</p><p className="text-white font-bold">{cycleStats.startWeight}</p></div>
                                <div className="border-r border-white/10"></div>
                                <div className="text-center"><p>ç›®å‰</p><p className="text-white font-bold">{cycleStats.currentWeight}</p></div>
                                <div className="border-r border-white/10"></div>
                                <div className="text-center"><p>å€’æ•¸</p><p className="text-indigo-300 font-bold">{28 - cycleStats.daysInCycle} å¤©</p></div>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                        <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><FileText className="w-5 h-5 text-emerald-400" /> é£²é£Ÿé€±å ±</h2>
                        <div className="grid grid-cols-2 gap-4 mb-8 text-center">
                            <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">å¹³å‡ç†±é‡</p><p className="text-2xl font-bold text-white">{average.cals}</p><p className="text-[10px] text-slate-500">ç›®æ¨™ {profile?.targetCalories}</p></div>
                            <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">å¹³å‡è›‹ç™½</p><p className="text-2xl font-bold text-blue-400">{average.pro}g</p><p className="text-[10px] text-slate-500">ç›®æ¨™ {profile?.protein}g</p></div>
                        </div>
                        
                        <div className="border-t border-slate-700 pt-6">
                            <button onClick={handleAnalyze} disabled={isAnalyzing || reportData.length === 0} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all disabled:opacity-50">
                                {isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <MessageSquare className="w-5 h-5" />}
                                {isAnalyzing ? "æ•™ç·´åˆ†æä¸­..." : "âœ¨ AI æ•™ç·´é€±å ±åˆ†æ"}
                            </button>
                            {analysis && <div className="mt-4 bg-slate-900/50 p-4 rounded-xl border border-blue-500/30"><div className="flex items-center gap-2 mb-2 text-blue-400 font-bold"><Sparkles className="w-4 h-4" /> æ•™ç·´å›é¥‹ï¼š</div><div className="text-slate-300 text-sm whitespace-pre-line leading-relaxed">{analysis}</div></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            const [view, setView] = useState('diary');
            const [isMobileFit, setIsMobileFit] = useState(false);
            const [isChatOpen, setIsChatOpen] = useState(false);

            useEffect(() => { 
                if(!auth) return;
                onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const fetchData = async () => {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) setProfile(docSnap.data()); else setView('settings');
                    try {
                        const configSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'));
                        if (configSnap.exists()) setApiKey(configSnap.data().gemini_api_key);
                    } catch(e) {}
                };
                fetchData();
            }, [user]);

            useEffect(() => {
                if (isMobileFit) document.getElementById('bg-layer').classList.add('mobile-fit');
                else document.getElementById('bg-layer').classList.remove('mobile-fit');
            }, [isMobileFit]);

            if (!auth) return <div className="loading">è¨­å®šæœªå®Œæˆ</div>;
            if (!user) return <LoginScreen onGuestLogin={() => signInAnonymously(auth)} onGoogleLogin={() => signInWithPopup(auth, new GoogleAuthProvider())} />;

            return (
                <div className="min-h-screen font-sans pb-20">
                    <header className="bg-slate-800/80 sticky top-0 z-10 border-b border-slate-700 px-4 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-2"><div className="bg-emerald-500 p-2 rounded-lg"><Activity className="text-slate-900 w-5 h-5" /></div><h1 className="text-xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">IronFuel</h1></div>
                        <div className="flex gap-3">
                            {profile && <div className="text-right text-xs"><p className="text-emerald-400 font-bold">{profile.targetCalories} kcal</p><p className="text-slate-500">{profile.goal === 'cut' ? 'æ¸›è„‚' : 'å¢è‚Œ'}</p></div>}
                            <button onClick={() => setIsMobileFit(!isMobileFit)} className={`p-2 rounded-lg ${isMobileFit ? 'bg-emerald-600' : 'bg-slate-700'}`}><Smartphone className="w-4 h-4" /></button>
                            <button onClick={() => signOut(auth)} className="p-2 bg-slate-700 rounded-lg"><LogOut className="w-4 h-4" /></button>
                        </div>
                    </header>
                    <main className="p-4 max-w-md mx-auto">
                        {view === 'settings' && <SettingsScreen user={user} profile={profile} setProfile={setProfile} onSave={async (p) => { await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), p); setProfile(p); }} hasApiKey={!!apiKey} />}
                        {view === 'diary' && <FoodDiary user={user} profile={profile} apiKey={apiKey} />}
                        {view === 'reports' && <Reports user={user} profile={profile} apiKey={apiKey} />}
                        {view === 'inbody' && <InBodyScan user={user} apiKey={apiKey} />}
                    </main>
                    {profile && <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-4 bg-emerald-600 p-4 rounded-full shadow-2xl z-40"><MessageCircle /></button>}
                    {profile && <AIChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} profile={profile} dayStats={{cals:0,pro:0,carbs:0,fat:0}} apiKey={apiKey} />}
                    <nav className="fixed bottom-0 left-0 w-full bg-slate-800 border-t border-slate-700 pb-safe z-30">
                        <div className="flex justify-around max-w-md mx-auto p-4">
                            <button onClick={() => setView('settings')} className={`flex flex-col items-center text-xs ${view === 'settings' ? 'text-emerald-400' : 'text-slate-500'}`}><Settings className="w-6 h-6" />è¨­å®š</button>
                            <button onClick={() => setView('diary')} className={`flex flex-col items-center text-xs ${view === 'diary' ? 'text-emerald-400' : 'text-slate-500'}`}><Utensils className="w-6 h-6" />æ—¥è¨˜</button>
                            <button onClick={() => setView('reports')} className={`flex flex-col items-center text-xs ${view === 'reports' ? 'text-emerald-400' : 'text-slate-500'}`}><BarChart3 className="w-6 h-6" />å ±è¡¨</button>
                            <button onClick={() => setView('inbody')} className={`flex flex-col items-center text-xs ${view === 'inbody' ? 'text-emerald-400' : 'text-slate-500'}`}><ScanLine className="w-6 h-6" />InBody</button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
