<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronFuel AI Diet Tracker</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¨­å®š Import Map ä»¥ä½¿ç”¨æ¨¡çµ„ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
      /* === åŸºç¤è¨­å®š === */
      body { 
        margin: 0;
        padding: 0;
        background-color: #0f172a; 
        color: white;
      }

      /* === ç¨ç«‹èƒŒæ™¯åœ–å±¤ === */
      #bg-layer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        
        background-image: url('./bg.jpg');
        background-repeat: no-repeat;
        
        /* é è¨­æ¨¡å¼ï¼šCover (å¡«æ»¿æ•´å€‹è¢å¹•ï¼Œé©åˆé›»è…¦) */
        background-size: cover;      
        background-position: center center; 
        transition: all 0.5s ease;
      }

      /* === ğŸ“± æ‰‹æ©Ÿé©é…æ¨¡å¼ (ç½®åº•) === */
      #bg-layer.mobile-fit {
        /* 1. å®Œæ•´é¡¯ç¤ºå¯¬åº¦ */
        background-size: contain !important;
        /* 2. é—œéµä¿®æ”¹ï¼šæ”¹ç‚ºç½®åº• (bottom)ï¼Œäººç‰©æœƒç«™åœ¨è¢å¹•ä¸‹æ–¹ */
        background-position: bottom center !important;
        /* 3. ä¸Šæ–¹ç•™ç™½è™•è£œä¸Šæ·±è—è‰²èƒŒæ™¯ */
        background-color: #0f172a; 
      }

      /* === å…§å®¹é®ç½©å±¤ === */
      #root {
        /* ç¨å¾®èª¿æ·¡ä¸€é»é®ç½©ï¼Œè®“èƒŒæ™¯æ›´æ¸…æ¥š */
        background-color: rgba(15, 23, 42, 0.85); 
        min-height: 100vh;
        width: 100%;
        position: relative;
        /* ç¢ºä¿åº•éƒ¨å°èˆªæ¬„ä¸æœƒæ“‹ä½å¤ªå¤šåœ–ç‰‡ï¼ŒåŠ ä¸€é» padding-bottom */
        padding-bottom: 100px; 
      }

      .loading { display: flex; justify-content: center; align-items: center; height: 100vh; color: #10b981; font-weight: bold; }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯åœ–å±¤ -->
    <div id="bg-layer"></div>

    <div id="root">
        <div class="loading">æ­£åœ¨å•Ÿå‹• IronFuel...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calculator, Camera, Utensils, BarChart3, ChevronRight, Plus, Trash2, Save, 
            Calendar as CalendarIcon, Loader2, TrendingDown, Target, Activity, ImagePlus, 
            FileText, Sparkles, ChefHat, MessageSquare, X, PenTool, Scale, MessageCircle, 
            Send, Bot, Key, LogOut, User, LogIn, Settings, Eye, EyeOff, CheckCircle2, 
            AlertTriangle, Copy, Database, Globe, Lock, ChevronDown, ChevronUp, Smartphone,
            Droplets, Flag, ArrowRight, Wand2, RefreshCcw, Trophy, ClipboardList, ScanLine
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            GoogleAuthProvider, signInWithPopup, signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, getDoc, addDoc, deleteDoc, 
            onSnapshot, query, orderBy, limit, Timestamp 
        } from 'firebase/firestore';

        // --- æ‚¨çš„ Firebase Config (å·²ä¿ç•™æ‚¨çš„è¨­å®š) ---
        const manualConfig = {
            apiKey: "AIzaSyA9kVApSCs6eD-u5U90f3dnjbI9TILpaLQ",
            authDomain: "ironfuel-cd5bf.firebaseapp.com",
            projectId: "ironfuel-cd5bf",
            storageBucket: "ironfuel-cd5bf.firebasestorage.app",
            messagingSenderId: "690568494476",
            appId: "1:690568494476:web:5ecda02b96a59d5bc66aa9",
            measurementId: "G-9YS0R1FD5J"
        };

        // --- App ID è¨­å®š ---
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const appId = envAppId || 'ironfuel-app'; 

        // --- Configuration ---
        const DEFAULT_GEMINI_MODEL = "gemini-1.5-flash";
        const DEFAULT_API_KEY = ""; 

        // --- æ™ºæ…§é›™æ¨¡å¼•æ“ ---
        const callGeminiAPI = async (apiKey, contents) => {
            const tryFetch = async (model) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            };

            try {
                return await tryFetch("gemini-2.5-flash-preview-09-2025");
            } catch (e) {
                console.warn("Gemini 2.5 é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›è‡³ 1.5 Flash...", e);
                return await tryFetch("gemini-1.5-flash");
            }
        };

        // --- åˆå§‹åŒ– Firebase ---
        let app, auth, db;
        try {
            let finalConfig = null;
            if (typeof __firebase_config !== 'undefined') {
                try { finalConfig = JSON.parse(__firebase_config); } catch (e) { console.error(e); }
            }
            if (!finalConfig && Object.keys(manualConfig).length > 0) {
                finalConfig = manualConfig;
            }

            if (finalConfig) {
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.error("å°šæœªè¨­å®š Firebase Config");
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        // --- Components ---

        const SimpleLineChart = ({ data, color = "#10b981", labelKey = "weight" }) => {
            if (!data || data.length < 2) return (
                <div className="h-40 flex items-center justify-center text-slate-500 text-xs border border-slate-700 border-dashed rounded-lg">
                è‡³å°‘éœ€è¦å…©ç­†è¨˜éŒ„æ‰èƒ½é¡¯ç¤ºè¶¨å‹¢åœ–
                </div>
            );

            const values = data.map(d => d[labelKey]);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const padding = (max - min) * 0.2 || 1; 
            const graphMin = min - padding;
            const graphMax = max + padding;
            const range = graphMax - graphMin;

            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((d[labelKey] - graphMin) / range) * 100;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-40 relative mt-4">
                <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <line x1="0" y1="25" x2="100" y2="25" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <line x1="0" y1="50" x2="100" y2="50" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <line x1="0" y1="75" x2="100" y2="75" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                    {data.map((d, i) => {
                    const x = (i / (data.length - 1)) * 100;
                    const y = 100 - ((d[labelKey] - graphMin) / range) * 100;
                    return <circle key={i} cx={x} cy={y} r="1.5" fill="#1e293b" stroke={color} strokeWidth="0.5" vectorEffect="non-scaling-stroke" />;
                    })}
                </svg>
                <div className="absolute top-0 left-0 text-[10px] text-slate-500 -mt-5">{max}kg</div>
                <div className="absolute bottom-0 left-0 text-[10px] text-slate-500 -mb-5">{min}kg</div>
                </div>
            );
        };

        const LoginScreen = ({ onGuestLogin, onGoogleLogin, isLoggingIn }) => {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                <div className="z-10 w-full max-w-md bg-slate-800/90 backdrop-blur-xl p-8 rounded-3xl border border-slate-700 shadow-2xl text-center">
                    <div className="mb-8 flex flex-col items-center">
                    <div className="bg-gradient-to-tr from-emerald-500 to-teal-500 p-4 rounded-2xl shadow-lg mb-4">
                        <Activity className="w-10 h-10 text-white" />
                    </div>
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">
                        IronFuel
                    </h1>
                    <p className="text-slate-400 mt-2 text-sm">æ‚¨çš„å°ˆå±¬ AI æ™ºèƒ½å¥èº«ç‡Ÿé¤Šæ•™ç·´</p>
                    </div>

                    <div className="space-y-4">
                    <button 
                        onClick={onGoogleLogin}
                        disabled={isLoggingIn}
                        className="w-full bg-white hover:bg-slate-100 text-slate-900 py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:scale-100"
                    >
                        {isLoggingIn ? <Loader2 className="w-5 h-5 animate-spin" /> : (
                        <span className="flex items-center gap-2">Google å¸³è™Ÿç™»å…¥</span>
                        )}
                    </button>

                    <div className="relative flex items-center py-2">
                        <div className="flex-grow border-t border-slate-600"></div>
                        <span className="flex-shrink-0 mx-4 text-slate-500 text-xs">æˆ–</span>
                        <div className="flex-grow border-t border-slate-600"></div>
                    </div>

                    <button 
                        onClick={onGuestLogin}
                        disabled={isLoggingIn}
                        className="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                        <User className="w-5 h-5" />
                        è¨ªå®¢è©¦ç”¨ (ä¸ä¿å­˜å¸³è™Ÿ)
                    </button>
                    </div>
                    
                    <p className="mt-8 text-xs text-slate-500">
                    Fuel your fight, build your steel.
                    </p>
                </div>
                </div>
            );
        };

        const AIChatModal = ({ isOpen, onClose, profile, dayStats, apiKey }) => {
            const [messages, setMessages] = useState([
                { role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å¥èº«æ•™ç·´ã€‚é—œæ–¼é£²é£Ÿã€è¨“ç·´æˆ–ç‡Ÿé¤Šï¼Œæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ' }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, isOpen]);

            const handleSend = async () => {
                if (!input.trim()) return;
                
                const userMessage = { role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                const remaining = {
                cals: profile.targetCalories - dayStats.cals,
                pro: profile.protein - dayStats.pro,
                carbs: profile.carbs - dayStats.carbs,
                fat: profile.fats - dayStats.fat
                };

                try {
                const contextPrompt = `
                    System Context:
                    You are "IronCoach", a friendly and professional fitness nutrition coach.
                    The user's data:
                    - Goal: ${profile.goal === 'cut' ? 'Weight Loss (Cutting)' : 'Muscle Gain (Bulking)'}
                    - Daily Target: ${profile.targetCalories} kcal, ${profile.protein}g Protein.
                    - Today's Status: Consumed ${dayStats.cals} kcal.
                    - Remaining Budget: ${remaining.cals} kcal, ${remaining.pro}g Protein.
                    
                    User Query: ${input}
                    
                    Instruction:
                    Answer the user in Traditional Chinese (ç¹é«”ä¸­æ–‡).
                    Keep the answer concise, encouraging, and practical.
                    If they ask for food recommendations, suggest items that fit their remaining macro budget.
                `;

                const data = await callGeminiAPI(apiKey, [{ parts: [{ text: contextPrompt }] }]);
                
                setMessages(prev => [...prev, { role: 'model', text: data.candidates?.[0]?.content?.parts?.[0]?.text }]);
                } catch (error) {
                console.error("Chat Error", error);
                setMessages(prev => [...prev, { role: 'model', text: `æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”ŸéŒ¯èª¤ (${error.message})ã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key è¨­å®šæˆ–ç¶²è·¯é€£ç·šã€‚` }]);
                } finally {
                setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4 animate-in fade-in duration-200">
                <div className="bg-slate-900 w-full max-w-md h-[80vh] rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <div className="bg-gradient-to-tr from-emerald-500 to-teal-500 p-2 rounded-lg">
                        <Bot className="w-5 h-5 text-white" />
                        </div>
                        <div>
                        <h3 className="text-white font-bold">IronCoach</h3>
                        <p className="text-[10px] text-emerald-400">AI æ™ºèƒ½æ•™ç·´åœ¨ç·šä¸­</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white">
                        <X className="w-6 h-6" />
                    </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900">
                    {messages.map((msg, idx) => (
                        <div 
                        key={idx} 
                        className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                        >
                        <div 
                            className={`max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed ${
                            msg.role === 'user' 
                                ? 'bg-emerald-600 text-white rounded-br-none' 
                                : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-bl-none'
                            }`}
                        >
                            {msg.text}
                        </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="flex justify-start">
                        <div className="bg-slate-800 p-3 rounded-2xl rounded-bl-none border border-slate-700 flex items-center gap-2">
                            <Loader2 className="w-4 h-4 text-emerald-500 animate-spin" />
                            <span className="text-xs text-slate-400">æ•™ç·´æ­£åœ¨æ€è€ƒ...</span>
                        </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 bg-slate-800 border-t border-slate-700">
                    <div className="flex gap-2">
                        <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                        placeholder="å•å•æ•™ç·´..."
                        className="flex-1 bg-slate-900 text-white p-3 rounded-xl border border-slate-700 focus:border-emerald-500 outline-none placeholder:text-slate-600"
                        />
                        <button 
                        onClick={handleSend}
                        disabled={isLoading || !input.trim()}
                        className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:hover:bg-emerald-600 text-white p-3 rounded-xl transition-colors"
                        >
                        <Send className="w-5 h-5" />
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const WaterTracker = ({ user, date }) => {
            const [water, setWater] = useState(0);
            const [target, setTarget] = useState(2500);
            useEffect(() => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'water_logs', date);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) { setWater(docSnap.data().amount || 0); if(docSnap.data().target) setTarget(docSnap.data().target); } else { setWater(0); }
                });
                return () => unsubscribe();
            }, [user, date]);
            const addWater = async (amount) => { const newAmount = Math.max(0, water + amount); await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'water_logs', date), { amount: newAmount, target: target, date: date }, { merge: true }); };
            const progress = Math.min(100, (water / target) * 100);
            return (<div className="bg-blue-900/30 border border-blue-500/30 p-4 rounded-2xl mb-6"><div className="flex justify-between items-center mb-3"><h3 className="text-blue-400 font-bold flex items-center gap-2"><Droplets className="w-5 h-5" /> å–æ°´ç´€éŒ„</h3><span className="text-xs text-blue-300">{water} / {target} ml</span></div><div className="w-full bg-slate-800 rounded-full h-4 mb-4 overflow-hidden relative"><div className="bg-blue-500 h-full transition-all duration-500 relative" style={{ width: `${progress}%` }}><div className="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse"></div></div></div><div className="flex gap-3 justify-between"><button onClick={() => addWater(-250)} className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 text-xs font-mono">-250ml</button><button onClick={() => addWater(250)} className="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/50 active:scale-95 transition-all"><Plus className="w-4 h-4" /> å–ä¸€æ¯ (250ml)</button></div></div>);
        };

        const PeriodizationPlanner = ({ profile }) => {
             const phases = [
                 { name: "é©æ‡‰æœŸ (Short)", duration: 4, focus: "å»ºç«‹ç¿’æ…£ã€æ¶ˆæ°´è…«", color: "text-emerald-400", border: "border-emerald-500/30" },
                 { name: "ç‡ƒè„‚æœŸ (Medium)", duration: 4, focus: "æœ€å¤§åŒ–ç†±é‡èµ¤å­—ã€é‡è¨“ä¿è‚Œ", color: "text-blue-400", border: "border-blue-500/30" },
                 { name: "è¡åˆºæœŸ (Long)", duration: 4, focus: "é ‘å›ºè„‚è‚ªã€æœ€å¾Œä¿®é£¾", color: "text-purple-400", border: "border-purple-500/30" }
             ];
             return (<div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 mt-6"><h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Flag className="w-5 h-5 text-yellow-400" /> æ¸›è„‚é€±æœŸè¦åŠƒ (12é€±)</h2><div className="space-y-3">{phases.map((phase, idx) => { const startWeek = idx * 4 + 1; const endWeek = (idx + 1) * 4; return (<div key={idx} className={`p-3 rounded-xl bg-slate-900/50 border ${phase.border} flex justify-between items-center`}><div><div className={`font-bold text-sm ${phase.color}`}>{phase.name}</div><div className="text-[10px] text-slate-500">ç¬¬ {startWeek} - {endWeek} é€±</div></div><div className="text-right"><div className="text-xs text-slate-300">{phase.focus}</div></div></div>) })}</div><div className="mt-4 p-3 bg-slate-900 rounded-lg text-xs text-slate-400 border border-slate-800"><p>ğŸ’¡ å»ºè­°æ¯ 4 é€±é‡æ–°è©•ä¼°ä¸€æ¬¡ TDEE èˆ‡é«”é‡ã€‚</p></div></div>);
        };

        const DailyMotivation = ({ profile, apiKey }) => {
            const [quote, setQuote] = useState("");
            useEffect(() => {
                if (!apiKey || !profile) return;
                const fetchQuote = async () => {
                    const today = new Date().toDateString();
                    const saved = localStorage.getItem('ironfuel_quote');
                    if (saved) { const parsed = JSON.parse(saved); if (parsed.date === today) { setQuote(parsed.text); return; } }
                    try {
                        const prompt = `Give me a short, powerful fitness motivational quote in Traditional Chinese for someone whose goal is "${profile.goal}". Max 20 words.`;
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "å …æŒå°±æ˜¯å‹åˆ©ï¼";
                        setQuote(text);
                        localStorage.setItem('ironfuel_quote', JSON.stringify({ date: today, text }));
                    } catch (e) { setQuote("ä»Šå¤©ä¹Ÿè¦åŠ æ²¹ï¼Fuel your fight!"); }
                };
                fetchQuote();
            }, [apiKey, profile]);
            if (!quote) return null;
            return (<div className="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 border-l-4 border-emerald-500 rounded-r-xl shadow-lg animate-in slide-in-from-top-4"><p className="text-sm text-emerald-100 italic font-medium">â€œ{quote}â€</p></div>);
        };

        const InBodyScan = ({ user, apiKey }) => {
            const [scans, setScans] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [lastScanDate, setLastScanDate] = useState(null);
            const fileInputRef = useRef(null);
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs'), orderBy('date', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const logs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setScans(logs);
                    if (logs.length > 0) { setLastScanDate(logs[0].date); }
                });
                return () => unsubscribe();
            }, [user]);
            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!apiKey) { alert("AI åŠŸèƒ½æœªå•Ÿç”¨"); return; }
                setIsAnalyzing(true);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const prompt = `Analyze this InBody sheet image. Extract: Weight, Skeletal Muscle Mass (SMM), Percent Body Fat (PBF). Also provide a short, encouraging assessment in Traditional Chinese (max 50 words). Return JSON: { "weight": number, "smm": number, "pbf": number, "assessment": string }`;
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64Data } }] }]);
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonStr);
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs'), {
                            ...result, date: new Date().toISOString().split('T')[0], timestamp: new Date().toISOString()
                        });
                        setIsAnalyzing(false); alert("InBody åˆ†æå®Œæˆï¼");
                    };
                } catch (error) { console.error(error); alert("åˆ†æå¤±æ•—"); setIsAnalyzing(false); }
            };
            const deleteScan = async (id) => { if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'inbody_logs', id)); };
            let nextScanMsg = "å°šæœªæª¢æ¸¬", statusColor = "text-slate-400", daysLeft = 0;
            if (lastScanDate) {
                const last = new Date(lastScanDate); const next = new Date(last); next.setDate(last.getDate() + 30);
                daysLeft = Math.ceil((next - new Date()) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 0) { nextScanMsg = "âš ï¸ å·²éæœŸï¼è«‹å„˜å¿«æª¢æ¸¬"; statusColor = "text-red-400"; } else { nextScanMsg = `é‚„æœ‰ ${daysLeft} å¤©`; statusColor = "text-emerald-400"; }
            }
            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                        <div className="flex justify-between items-start mb-4"><div><h2 className="text-xl font-bold text-white flex items-center gap-2"><ScanLine className="w-5 h-5 text-blue-400" /> InBody è¿½è¹¤</h2><p className="text-xs text-slate-400 mt-1">å®šæœŸè¿½è¹¤èº«é«”çµ„æˆè®ŠåŒ–</p></div><div className="text-right"><p className="text-[10px] text-slate-500">ä¸‹æ¬¡æª¢æ¸¬</p><p className={`text-sm font-bold ${statusColor}`}>{nextScanMsg}</p></div></div>
                        <button onClick={() => fileInputRef.current.click()} disabled={isAnalyzing} className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all disabled:opacity-50">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <Camera className="w-5 h-5" />}{isAnalyzing ? "AI åˆ†æå ±å‘Šä¸­..." : "ä¸Šå‚³æœ¬æœˆå ±å‘Š (AI åˆ†æ)"}</button><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleUpload} />
                    </div>
                    <div className="space-y-4"><h3 className="text-white font-semibold text-sm ml-1">æ­·å²ç´€éŒ„</h3>{scans.length === 0 ? (<div className="text-center p-8 border-2 border-dashed border-slate-700 rounded-xl text-slate-500 text-xs">å°šç„¡ç´€éŒ„ï¼Œè«‹ä¸Šå‚³æ‚¨çš„ç¬¬ä¸€ä»½ InBody å ±å‘Šã€‚</div>) : (scans.map(scan => (<div key={scan.id} className="bg-slate-900/50 border border-slate-700 p-4 rounded-xl relative group"><div className="flex justify-between items-center mb-2"><span className="text-emerald-400 font-mono font-bold">{scan.date}</span><button onClick={() => deleteScan(scan.id)} className="text-slate-600 hover:text-red-400"><Trash2 className="w-4 h-4" /></button></div><div className="grid grid-cols-3 gap-2 mb-3 text-center"><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">é«”é‡</p><p className="text-white font-bold">{scan.weight}kg</p></div><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">éª¨éª¼è‚Œ</p><p className="text-blue-400 font-bold">{scan.smm}kg</p></div><div className="bg-slate-800 p-2 rounded-lg"><p className="text-[10px] text-slate-400">é«”è„‚ç‡</p><p className="text-yellow-400 font-bold">{scan.pbf}%</p></div></div>{scan.assessment && (<div className="text-xs text-slate-300 bg-slate-800 p-3 rounded-lg italic border-l-2 border-blue-500">" {scan.assessment} "</div>)}</div>)))}</div>
                </div>
            );
        };

        const SettingsScreen = ({ user, profile, setProfile, onSave, hasApiKey }) => {
            const [formData, setFormData] = useState(profile || { height: 171, weight: 80, age: 30, gender: 'male', activityLevel: '1.55', goal: 'cut', bodyFat: 21 });
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState("");
            const [showAdmin, setShowAdmin] = useState(false);
            const calculateTDEE = () => {
                let bmr = (10 * formData.weight) + (6.25 * formData.height) - (5 * formData.age);
                // é—œéµä¿®æ­£ï¼šåŠ å…¥æ€§åˆ¥åˆ¤æ–·
                bmr += formData.gender === 'male' ? 5 : -161;
                
                const tdee = Math.round(bmr * parseFloat(formData.activityLevel));
                let targetCalories = tdee;
                let protein = 0, carbs = 0, fats = 0;
                if (formData.goal === 'cut') { targetCalories = tdee - 500; protein = Math.round(formData.weight * 2.2); fats = Math.round(formData.weight * 0.9); } 
                else if (formData.goal === 'bulk') { targetCalories = tdee + 300; protein = Math.round(formData.weight * 2.0); fats = Math.round(formData.weight * 1.0); } 
                else { protein = Math.round(formData.weight * 1.8); fats = Math.round(formData.weight * 1.0); }
                const remainingCals = targetCalories - (protein * 4) - (fats * 9);
                carbs = Math.max(0, Math.round(remainingCals / 4));
                return { tdee, targetCalories, protein, carbs, fats };
            };
            const results = calculateTDEE();
            const handleSave = async () => {
                setIsSaving(true); setSaveMessage("");
                await onSave({ ...formData, ...results });
                setIsSaving(false); setSaveMessage("âœ… èº«é«”æ•¸æ“šå·²æ›´æ–°ï¼"); setTimeout(() => setSaveMessage(""), 3000);
            };
            const handleCopy = (text, label) => { navigator.clipboard.writeText(text); alert(`${label} å·²è¤‡è£½ï¼`); }
            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                <div className="flex items-center justify-between"><h2 className="text-xl font-bold text-emerald-400 flex items-center gap-2"><Activity className="w-5 h-5" /> èº«é«”æ•¸æ“šè¨­å®š</h2>{hasApiKey ? (<div className="flex items-center gap-1.5 px-3 py-1 bg-emerald-900/30 rounded-full border border-emerald-500/30"><div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div><span className="text-[10px] text-emerald-300 font-medium">AI å·²é€£ç·š</span></div>) : (<div className="flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full border border-slate-700"><div className="w-2 h-2 rounded-full bg-slate-500"></div><span className="text-[10px] text-slate-400 font-medium">AI é›¢ç·š</span></div>)}</div>
                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                    {/* æ–°å¢ï¼šæ€§åˆ¥é¸æ“‡ */}
                    <div className="mb-4">
                        <label className="text-slate-400 text-xs uppercase tracking-wider block mb-1">ç”Ÿç†æ€§åˆ¥ (å½±éŸ¿ TDEE è¨ˆç®—)</label>
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setFormData({...formData, gender: 'male'})}
                                className={`flex-1 py-3 rounded-lg text-sm font-bold transition-colors ${formData.gender === 'male' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                            >
                                ç”·æ€§ (Male)
                            </button>
                            <button 
                                onClick={() => setFormData({...formData, gender: 'female'})}
                                className={`flex-1 py-3 rounded-lg text-sm font-bold transition-colors ${formData.gender === 'female' ? 'bg-pink-600 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                            >
                                å¥³æ€§ (Female)
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                    <div><label className="text-slate-400 text-xs uppercase tracking-wider">èº«é«˜ (cm)</label><input type="number" value={formData.height} onChange={(e) => setFormData({...formData, height: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" /></div>
                    <div><label className="text-slate-400 text-xs uppercase tracking-wider">é«”é‡ (kg)</label><input type="number" value={formData.weight} onChange={(e) => setFormData({...formData, weight: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" /></div>
                    <div><label className="text-slate-400 text-xs uppercase tracking-wider">å¹´é½¡</label><input type="number" value={formData.age} onChange={(e) => setFormData({...formData, age: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" /></div>
                    <div><label className="text-slate-400 text-xs uppercase tracking-wider">é«”è„‚ç‡ (%)</label><input type="number" value={formData.bodyFat} onChange={(e) => setFormData({...formData, bodyFat: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" /></div>
                    </div>
                    <div className="mt-4"><label className="text-slate-400 text-xs uppercase tracking-wider">æ´»å‹•é‡</label><select value={formData.activityLevel} onChange={(e) => setFormData({...formData, activityLevel: e.target.value})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none"><option value="1.2">ä¹…åä¸å‹•</option><option value="1.375">è¼•åº¦æ´»å‹• (1-3å¤©)</option><option value="1.55">ä¸­åº¦æ´»å‹• (3-5å¤©)</option><option value="1.725">é«˜åº¦æ´»å‹• (6-7å¤©)</option></select></div>
                    <div className="mt-4"><label className="text-slate-400 text-xs uppercase tracking-wider">ç›®æ¨™</label><div className="flex gap-2 mt-1">{['cut', 'maintain', 'bulk'].map(mode => (<button key={mode} onClick={() => setFormData({...formData, goal: mode})} className={`flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-colors ${formData.goal === mode ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>{mode === 'cut' ? 'æ¸›è„‚' : mode === 'maintain' ? 'ç¶­æŒ' : 'å¢è‚Œ'}</button>))}</div></div>
                </div>
                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-10"><Target className="w-24 h-24 text-emerald-400" /></div>
                    <h3 className="text-lg font-semibold text-white mb-4">é è¦½ï¼šæ¯æ—¥ç‡Ÿé¤Šç›®æ¨™</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">ç›®æ¨™ç†±é‡</p><p className="text-2xl font-bold text-emerald-400">{results.targetCalories}</p><p className="text-xs text-slate-500">kcal</p></div>
                    <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">è›‹ç™½è³ª</p><p className="text-xl font-bold text-blue-400">{results.protein}g</p><p className="text-xs text-slate-500">é«˜è›‹ç™½ä¿è‚Œ</p></div>
                    <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">ç¢³æ°´åŒ–åˆç‰©</p><p className="text-xl font-bold text-yellow-400">{results.carbs}g</p><p className="text-xs text-slate-500">è¨“ç·´ç‡ƒæ–™</p></div>
                    <div className="bg-slate-900/50 p-3 rounded-xl"><p className="text-slate-400 text-xs">è„‚è‚ª</p><p className="text-xl font-bold text-red-400">{results.fats}g</p><p className="text-xs text-slate-500">è·çˆ¾è’™ç¶­æŒ</p></div>
                    </div>
                    <button onClick={handleSave} disabled={isSaving} className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-900/20">{isSaving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}{isSaving ? "æ­£åœ¨å„²å­˜..." : "å„²å­˜ä¸¦æ›´æ–°ç›®æ¨™"}</button>
                    {saveMessage && <div className="mt-3 p-3 bg-emerald-500/20 border border-emerald-500/50 rounded-lg flex items-center gap-2 text-emerald-400 text-sm justify-center animate-in fade-in slide-in-from-bottom-2"><CheckCircle2 className="w-4 h-4" /> {saveMessage}</div>}
                </div>
                <PeriodizationPlanner profile={profile} />
                <div className="pt-8 border-t border-slate-800/50 text-center">
                    <button onClick={() => setShowAdmin(!showAdmin)} className="text-[10px] text-slate-700 hover:text-slate-500 transition-colors flex items-center justify-center gap-1 mx-auto">{showAdmin ? <ChevronUp className="w-3 h-3" /> : <Lock className="w-3 h-3" />}{showAdmin ? "éš±è—ç®¡ç†è¨­å®š" : "ç®¡ç†å“¡è¨­ç½® (Admin Only)"}</button>
                    {showAdmin && (<div className="mt-6 text-left bg-slate-900 p-4 rounded-xl border border-slate-700 animate-in slide-in-from-bottom-4"><div className="flex items-center gap-2 mb-3 text-yellow-500"><Database className="w-4 h-4" /><span className="font-bold text-sm">Firebase é€£ç·šè³‡è¨Š</span></div><div className="text-xs text-slate-500 mb-4 space-y-2"><p>è«‹ç¢ºèªæ‚¨çš„ API Key ä½æ–¼ä»¥ä¸‹ Firebase è·¯å¾‘ (é»æ“Šè¤‡è£½ App ID):</p><div className="bg-black/30 p-2 rounded font-mono text-emerald-400 break-all">artifacts / {appId} / public / data / config / settings</div><p className="italic text-slate-600">æ¬„ä½: gemini_api_key (String)</p></div><div className="space-y-2"><div><label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">App ID</label><div className="flex gap-2 mt-1"><code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">{appId}</code><button onClick={() => handleCopy(appId, "App ID")} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button></div></div><div><label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">User ID</label><div className="flex gap-2 mt-1"><code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">{user.uid}</code><button onClick={() => handleCopy(user.uid, "User ID")} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button></div></div></div></div>)}
                </div>
                </div>
            );
        };

        const FoodDiary = ({ user, profile, apiKey }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [logs, setLogs] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isSuggesting, setIsSuggesting] = useState(false);
            const [suggestion, setSuggestion] = useState(null);
            const [isManualOpen, setIsManualOpen] = useState(false);
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [manualData, setManualData] = useState({ name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: '' });
            const [aiHint, setAiHint] = useState("");
            const [smartText, setSmartText] = useState("");
            const [isSmartParsing, setIsSmartParsing] = useState(false);

            const fileInputRef = useRef(null);
            const [dayStats, setDayStats] = useState({ cals: 0, pro: 0, carbs: 0, fat: 0 });

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const allLogs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const todaysLogs = allLogs.filter(log => log.date === date);
                setLogs(todaysLogs);
                const stats = todaysLogs.reduce((acc, curr) => ({
                    cals: acc.cals + (curr.calories || 0), pro: acc.pro + (curr.protein || 0), carbs: acc.carbs + (curr.carbs || 0), fat: acc.fat + (curr.fat || 0),
                }), { cals: 0, pro: 0, carbs: 0, fat: 0 });
                setDayStats(stats);
                });
                return () => unsubscribe();
            }, [user, date]);

            const handleManualSubmit = async () => {
                if (!manualData.name || !manualData.calories) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), {
                    name: manualData.name, mealType: manualData.mealType, calories: Number(manualData.calories), protein: Number(manualData.protein) || 0, carbs: Number(manualData.carbs) || 0, fat: Number(manualData.fat) || 0, date: date, timestamp: new Date().toISOString()
                });
                setIsManualOpen(false);
                setManualData({ name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: '' });
                setSmartText("");
            };

            const handleSmartTextAnalysis = async () => {
                if (!smartText.trim()) return;
                if (!apiKey) { alert("AI åŠŸèƒ½æœªå•Ÿç”¨"); return; }
                setIsSmartParsing(true);
                try {
                    const prompt = `Parse this food description into nutritional data. Text: "${smartText}". Return ONLY valid JSON: { "name": "Summarized Food Name", "calories": number, "protein": number, "carbs": number, "fat": number }. Estimate values if not specified. Use Traditional Chinese for the name.`;
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsed = JSON.parse(jsonStr);
                    setManualData({ name: parsed.name, mealType: 'lunch', calories: parsed.calories, protein: parsed.protein, carbs: parsed.carbs, fat: parsed.fat });
                } catch (error) { console.error(error); alert("AI åˆ†æå¤±æ•—ï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥"); } finally { setIsSmartParsing(false); }
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!apiKey) { alert("AI åŠŸèƒ½å°šæœªå•Ÿç”¨"); return; }
                setIsAnalyzing(true); setIsCameraOpen(false);
                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const base64Data = reader.result.split(',')[1];
                        const mimeType = file.type;
                        const userPrompt = aiHint ? `User hint: The food is "${aiHint}". Please use this to identify better.` : "";
                        const prompt = `${userPrompt} Analyze this food image. Identify the food item and estimate its nutritional values. Return ONLY valid JSON: { "name": "Food Name", "calories": number, "protein": number, "carbs": number, "fat": number, "note": "Brief explanation" }. Do not use markdown.`;
                        const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }, { inlineData: { mimeType: mimeType, data: base64Data } }] }]);
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const foodData = JSON.parse(jsonStr);
                        setManualData({ name: foodData.name, mealType: 'lunch', calories: foodData.calories, protein: foodData.protein, carbs: foodData.carbs, fat: foodData.fat });
                        setIsManualOpen(true); setAiHint(""); setIsAnalyzing(false);
                    };
                } catch (error) { console.error("AI Error:", error); alert(`AI åˆ†æå¤±æ•—: ${error.message}`); setIsAnalyzing(false); }
            };
            const deleteLog = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'logs', id)); };
            const getMealSuggestion = async () => {
                if (!apiKey) { alert("AI åŠŸèƒ½å°šæœªå•Ÿç”¨"); return; }
                setIsSuggesting(true); setSuggestion(null);
                const remaining = { cals: profile.targetCalories - dayStats.cals, pro: profile.protein - dayStats.pro, carbs: profile.carbs - dayStats.carbs, fat: profile.fats - dayStats.fat };
                try {
                    const prompt = `æˆ‘æ˜¯å¥èº«æ•™ç·´ã€‚å­¸ç”Ÿå‰©ä¸‹é¡åº¦ï¼šç†±é‡ ${remaining.cals}kcal, è›‹ ${remaining.pro}g, ç¢³ ${remaining.carbs}g, è„‚ ${remaining.fat}gã€‚ç›®æ¨™ï¼š${profile.goal}ã€‚è«‹å»ºè­°ä¸€é¤ï¼Œç¹é«”ä¸­æ–‡ã€‚å›å‚³ JSON: { "mealName": "åç¨±", "reason": "ç†ç”±", "ingredients": "é£Ÿæ", "estimatedNutrition": "é ä¼°ç‡Ÿé¤Š" }`;
                    const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    setSuggestion(JSON.parse(jsonStr));
                } catch (error) { alert("AI æ€è€ƒè¶…æ™‚"); } finally { setIsSuggesting(false); }
            };
            const Progress = ({ current, target, color }) => { const pct = Math.min((current / target) * 100, 100); return <div className="w-full bg-slate-700 rounded-full h-2 mt-1"><div className={`h-2 rounded-full ${color} transition-all duration-500`} style={{ width: `${pct}%` }} /></div>; };

            return (
                <div className="space-y-6">
                <DailyMotivation profile={profile} apiKey={apiKey} />
                <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() - 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5 rotate-180 text-slate-400"/></button>
                    <div className="flex items-center gap-2 text-white font-medium"><CalendarIcon className="w-5 h-5 text-emerald-500" />{date}</div>
                    <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() + 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5 text-slate-400"/></button>
                </div>
                <WaterTracker user={user} date={date} />
                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <div className="flex justify-between items-end mb-4"><div><h3 className="text-slate-400 text-sm">ä»Šæ—¥ç†±é‡</h3><div className="flex items-baseline gap-2"><span className="text-3xl font-bold text-white">{dayStats.cals}</span><span className="text-sm text-slate-500">/ {profile?.targetCalories} kcal</span></div></div><div className="text-right"><span className={`text-sm font-bold ${profile?.targetCalories - dayStats.cals >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{profile?.targetCalories - dayStats.cals >= 0 ? 'å‰©é¤˜' : 'è¶…æ¨™'} {Math.abs(profile?.targetCalories - dayStats.cals)}</span></div></div>
                    <Progress current={dayStats.cals} target={profile?.targetCalories} color="bg-emerald-500" />
                    <div className="grid grid-cols-3 gap-4 mt-6"><div className="text-center"><p className="text-xs text-slate-400 mb-1">è›‹ç™½è³ª</p><p className="text-lg font-bold text-blue-400">{dayStats.pro}g</p><p className="text-[10px] text-slate-500">ç›®æ¨™ {profile?.protein}g</p><Progress current={dayStats.pro} target={profile?.protein} color="bg-blue-500" /></div><div className="text-center"><p className="text-xs text-slate-400 mb-1">ç¢³æ°´</p><p className="text-lg font-bold text-yellow-400">{dayStats.carbs}g</p><p className="text-[10px] text-slate-500">ç›®æ¨™ {profile?.carbs}g</p><Progress current={dayStats.carbs} target={profile?.carbs} color="bg-yellow-500" /></div><div className="text-center"><p className="text-xs text-slate-400 mb-1">è„‚è‚ª</p><p className="text-lg font-bold text-red-400">{dayStats.fat}g</p><p className="text-[10px] text-slate-500">ç›®æ¨™ {profile?.fats}g</p><Progress current={dayStats.fat} target={profile?.fats} color="bg-red-500" /></div></div>
                </div>
                {suggestion && (<div className="bg-gradient-to-br from-indigo-900 to-slate-900 p-5 rounded-2xl border border-indigo-500/50 relative animate-in slide-in-from-top-4"><button onClick={() => setSuggestion(null)} className="absolute top-3 right-3 text-slate-400 hover:text-white"><X className="w-5 h-5" /></button><div className="flex items-center gap-2 mb-3"><Sparkles className="w-5 h-5 text-indigo-400" /><h3 className="font-bold text-white">AI æ™ºèƒ½é¤é»å»ºè­°</h3></div><h4 className="text-xl font-bold text-indigo-300 mb-2">{suggestion.mealName}</h4><p className="text-slate-300 text-sm mb-3">{suggestion.reason}</p><div className="bg-black/30 p-3 rounded-lg text-sm text-slate-300 mb-3"><strong>å»ºè­°é£Ÿæï¼š</strong> {suggestion.ingredients}</div><div className="text-xs text-indigo-400 font-mono">{suggestion.estimatedNutrition}</div></div>)}

                {isManualOpen && (
                    <div className="bg-slate-800 p-5 rounded-2xl border border-slate-600 animate-in slide-in-from-top-2">
                    <div className="flex justify-between items-center mb-4"><h3 className="text-white font-bold flex items-center gap-2"><PenTool className="w-5 h-5 text-emerald-400" /> {manualData.name ? 'ç¢ºèªä¸¦ç·¨è¼¯é¤é»' : 'æ–°å¢é¤é»'}</h3><button onClick={() => setIsManualOpen(false)} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button></div>
                    
                    {/* æ–°å¢ï¼šAI é€Ÿè¨˜è¼¸å…¥å€ */}
                    <div className="bg-slate-900/50 p-3 rounded-xl mb-4 border border-slate-700">
                        <label className="text-xs text-emerald-400 block mb-2 flex items-center gap-1"><Sparkles className="w-3 h-3" /> AI é€Ÿè¨˜ (è¼¸å…¥å¦‚: é›è…¿ä¾¿ç•¶å»çš®)</label>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                placeholder="è¼¸å…¥é£Ÿç‰©æè¿°..." 
                                className="flex-1 bg-slate-950 text-white p-2 rounded-lg border border-slate-600 text-sm"
                                value={smartText}
                                onChange={(e) => setSmartText(e.target.value)}
                            />
                            <button 
                                onClick={handleSmartTextAnalysis}
                                disabled={isSmartParsing || !smartText}
                                className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 text-white px-3 rounded-lg text-xs font-bold flex items-center"
                            >
                                {isSmartParsing ? <Loader2 className="w-4 h-4 animate-spin" /> : <Wand2 className="w-4 h-4" />}
                            </button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div><label className="text-xs text-slate-400 block mb-1">é¤é»åç¨±</label><input type="text" placeholder="ä¾‹å¦‚ï¼šé›èƒ¸è‚‰æ²™æ‹‰" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 focus:border-emerald-500 outline-none" value={manualData.name} onChange={e => setManualData({...manualData, name: e.target.value})} /></div>
                        <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs text-slate-400 block mb-1">ç”¨é¤æ™‚æ®µ</label><select className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.mealType} onChange={e => setManualData({...manualData, mealType: e.target.value})}><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option><option value="snack">é»å¿ƒ/é¡å¤–</option></select></div>
                        <div><label className="text-xs text-slate-400 block mb-1">ç†±é‡ (kcal)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.calories} onChange={e => setManualData({...manualData, calories: e.target.value})} /></div>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                        <div><label className="text-xs text-slate-400 block mb-1">è›‹ç™½è³ª (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.protein} onChange={e => setManualData({...manualData, protein: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">ç¢³æ°´ (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.carbs} onChange={e => setManualData({...manualData, carbs: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">è„‚è‚ª (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.fat} onChange={e => setManualData({...manualData, fat: e.target.value})} /></div>
                        </div>
                        <button onClick={handleManualSubmit} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold mt-2">ç¢ºèªä¸¦åŠ å…¥æ—¥è¨˜</button>
                    </div>
                    </div>
                )}

                {!isManualOpen && !isCameraOpen && (
                    <div className="grid grid-cols-3 gap-2">
                    <button onClick={() => setIsManualOpen(true)} className="bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all"><PenTool className="w-5 h-5 text-emerald-400" /><span className="text-xs">æ‰‹å‹•è¼¸å…¥</span></button>
                    <button onClick={() => setIsCameraOpen(true)} disabled={isAnalyzing} className="bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <Camera className="w-5 h-5 text-blue-400" />}<span className="text-xs">{isAnalyzing ? "åˆ†æä¸­..." : "æ‹ç…§è¨˜éŒ„"}</span></button>
                    <button onClick={getMealSuggestion} disabled={isSuggesting} className="bg-gradient-to-br from-indigo-600 to-purple-700 hover:from-indigo-500 hover:to-purple-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all">{isSuggesting ? <Loader2 className="w-5 h-5 animate-spin" /> : <ChefHat className="w-5 h-5 text-yellow-300" />}<span className="text-xs">{isSuggesting ? "æ€è€ƒä¸­..." : "AI å»ºè­°"}</span></button>
                    </div>
                )}
                {isCameraOpen && (
                    <div className="bg-slate-800 p-4 rounded-xl border border-blue-500 animate-in slide-in-from-bottom-4">
                        <div className="flex justify-between mb-2"><h4 className="font-bold text-blue-400 flex items-center gap-2"><Sparkles className="w-4 h-4" /> AI è¾¨è­˜å°å¹«æ‰‹</h4><button onClick={() => setIsCameraOpen(false)}><X className="w-5 h-5 text-slate-400" /></button></div>
                        <p className="text-xs text-slate-400 mb-3">æ‚¨å¯ä»¥å‘Šè¨´ AI é€™æ˜¯ä»€éº¼é£Ÿç‰©ï¼Œè¾¨è­˜æœƒæ›´æº–ç¢ºï¼(å¯é¸)</p>
                        <input type="text" value={aiHint} onChange={(e) => setAiHint(e.target.value)} placeholder="ä¾‹å¦‚ï¼šSukiya ç‰›ä¸¼é£¯å°‘..." className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none mb-3 text-sm" />
                        <button onClick={() => fileInputRef.current.click()} className="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><Camera className="w-5 h-5" /> é¸æ“‡ç…§ç‰‡ä¸¦åˆ†æ</button>
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                    </div>
                )}
                <div className="space-y-3 pb-20 mt-3">
                    <h3 className="text-white font-semibold text-lg flex items-center gap-2"><Utensils className="w-5 h-5 text-slate-400" /> ä»Šæ—¥é¤é»</h3>
                    {logs.length === 0 ? <div className="text-center p-8 border-2 border-dashed border-slate-700 rounded-xl"><p className="text-slate-500">ä»Šå¤©é‚„æ²’ç´€éŒ„å–”ï¼</p></div> : 
                    logs.map((log) => (
                        <div key={log.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center group"><div><div className="flex items-center gap-2"><h4 className="text-white font-medium text-lg">{log.name}</h4>{log.mealType && <span className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full uppercase">{log.mealType === 'breakfast' ? 'æ—©é¤' : log.mealType === 'lunch' ? 'åˆé¤' : log.mealType === 'dinner' ? 'æ™šé¤' : log.mealType === 'snack' ? 'é»å¿ƒ' : 'è‡ªå‹•'}</span>}</div><div className="flex gap-3 text-sm text-slate-400 mt-1"><span className="text-emerald-400 font-bold">{log.calories} kcal</span><span>P: {log.protein}g</span><span>C: {log.carbs}g</span><span>F: {log.fat}g</span></div>{log.note && <p className="text-xs text-slate-500 mt-1 italic">{log.note}</p>}</div><button onClick={() => deleteLog(log.id)} className="p-2 text-slate-600 hover:text-red-400 hover:bg-slate-700 rounded-full transition-colors"><Trash2 className="w-5 h-5" /></button></div>
                    ))
                    }
                </div>
                </div>
            );
        };

        const Reports = ({ user, profile, apiKey }) => {
            const [reportData, setReportData] = useState([]);
            const [average, setAverage] = useState({ cals: 0, pro: 0 });
            const [analysis, setAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [weightLogs, setWeightLogs] = useState([]);
            const [currentWeight, setCurrentWeight] = useState("");
            const [cycleStats, setCycleStats] = useState(null);

            useEffect(() => {
                if(!user) return;
                const qLogs = query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), orderBy('date', 'desc'));
                const unsubscribeLogs = onSnapshot(qLogs, (snapshot) => {
                const allLogs = snapshot.docs.map(d => d.data());
                const grouped = allLogs.reduce((acc, curr) => {
                    if (!acc[curr.date]) { acc[curr.date] = { date: curr.date, cals: 0, pro: 0, carbs: 0, fat: 0 }; }
                    acc[curr.date].cals += (curr.calories || 0);
                    acc[curr.date].pro += (curr.protein || 0);
                    acc[curr.date].carbs += (curr.carbs || 0);
                    acc[curr.date].fat += (curr.fat || 0);
                    return acc;
                }, {});
                const sortedDays = Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-7);
                setReportData(sortedDays);
                if (sortedDays.length > 0) {
                    const totalCals = sortedDays.reduce((sum, d) => sum + d.cals, 0);
                    const totalPro = sortedDays.reduce((sum, d) => sum + d.pro, 0);
                    setAverage({ cals: Math.round(totalCals / sortedDays.length), pro: Math.round(totalPro / sortedDays.length) });
                }
                });
                const qWeight = query(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), orderBy('date', 'asc'));
                const unsubscribeWeight = onSnapshot(qWeight, (snapshot) => { 
                    const wLogs = snapshot.docs.map(d => d.data()); 
                    setWeightLogs(wLogs); 
                    
                    // è¨ˆç®— 4 é€±é€±æœŸç‹€æ…‹
                    if (wLogs.length > 0) {
                        const sortedWeights = [...wLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const latest = sortedWeights[sortedWeights.length - 1];
                        const today = new Date();
                        const fourWeeksAgoDate = new Date();
                        fourWeeksAgoDate.setDate(today.getDate() - 28);
                        const fourWeeksAgoStr = fourWeeksAgoDate.toISOString().split('T')[0];
                        
                        // æ‰¾åˆ°æœ€æ¥è¿‘ 4 é€±å‰çš„ç´€éŒ„ (æˆ–ç¬¬ä¸€ç­†)
                        const startLog = sortedWeights.find(w => w.date >= fourWeeksAgoStr) || sortedWeights[0];
                        
                        // è¨ˆç®—ç¶“éå¤©æ•¸
                        const daysDiff = Math.floor((new Date(latest.date) - new Date(startLog.date)) / (1000 * 60 * 60 * 24));
                        const cycleDay = Math.min(28, Math.max(1, daysDiff)); // é™åˆ¶åœ¨ 1-28 å¤©
                        
                        setCycleStats({
                            startWeight: startLog.weight,
                            currentWeight: latest.weight,
                            change: (latest.weight - startLog.weight).toFixed(1),
                            daysInCycle: cycleDay
                        });
                    }
                });
                return () => { unsubscribeLogs(); unsubscribeWeight(); };
            }, [user]);

            const handleAddWeight = async () => {
                if (!currentWeight) return;
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), { date: today, weight: Number(currentWeight), timestamp: new Date().toISOString() });
                setCurrentWeight("");
            };

            const handleAnalyze = async () => {
                if (reportData.length === 0) return;
                if (!apiKey) { alert("AI åŠŸèƒ½å°šæœªå•Ÿç”¨"); return; }
                setIsAnalyzing(true);
                setAnalysis("");
                try {
                const prompt = `ä½œç‚ºå¥èº«æ•™ç·´ï¼Œåˆ†æé€™7å¤©æ•¸æ“šï¼š${JSON.stringify(reportData)}ã€‚é«”é‡ç´€éŒ„ï¼š${JSON.stringify(weightLogs.slice(-5))}ã€‚ç›®æ¨™ï¼š${profile.goal}ã€‚ç¹é«”ä¸­æ–‡å›è¦†ï¼Œç°¡çŸ­å»ºè­°ã€‚`;
                const data = await callGeminiAPI(apiKey, [{ parts: [{ text: prompt }] }]);
                setAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { alert("åˆ†æå¤±æ•—"); } finally { setIsAnalyzing(false); }
            };

            return (
                <div className="space-y-6">
                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Scale className="w-5 h-5 text-emerald-400" /> é«”é‡è¿½è¹¤</h2>
                    <div className="flex gap-2 mb-4">
                    <input type="number" placeholder="ä»Šæ—¥é«”é‡ (kg)" className="flex-1 bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={currentWeight} onChange={(e) => setCurrentWeight(e.target.value)} />
                    <button onClick={handleAddWeight} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded-lg font-bold">è¨˜éŒ„</button>
                    </div>
                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 min-h-[200px]">
                    <h3 className="text-xs text-slate-400 mb-2">è¿‘æœŸé«”é‡è¶¨å‹¢</h3>
                    <SimpleLineChart data={weightLogs} />
                    </div>
                </div>

                {/* 4é€±é€±æœŸæˆ°æƒ…å®¤ */}
                {cycleStats && (
                    <div className="bg-gradient-to-br from-slate-800 to-indigo-900 p-6 rounded-2xl border border-indigo-500/30 shadow-xl animate-in slide-in-from-bottom-4">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-lg font-bold text-white flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-400" /> 4é€±é€±æœŸæˆ°æƒ…å®¤</h3>
                                <p className="text-xs text-indigo-200 mt-1">é€±æœŸé€²åº¦: ç¬¬ {cycleStats.daysInCycle} / 28 å¤©</p>
                            </div>
                            <div className={`text-2xl font-bold ${cycleStats.change <= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {cycleStats.change > 0 ? '+' : ''}{cycleStats.change} <span className="text-sm">kg</span>
                            </div>
                        </div>
                        
                        {/* é€²åº¦æ¢ */}
                        <div className="w-full bg-slate-900 rounded-full h-2 mb-4">
                            <div className="bg-indigo-500 h-2 rounded-full transition-all duration-1000" style={{ width: `${(cycleStats.daysInCycle / 28) * 100}%` }}></div>
                        </div>

                        <div className="flex justify-between text-xs text-slate-400 bg-black/20 p-3 rounded-lg">
                            <div className="text-center">
                                <p className="mb-1">èµ·é»é«”é‡</p>
                                <p className="text-white font-bold">{cycleStats.startWeight} kg</p>
                            </div>
                            <div className="border-r border-white/10"></div>
                            <div className="text-center">
                                <p className="mb-1">ç›®å‰é«”é‡</p>
                                <p className="text-white font-bold">{cycleStats.currentWeight} kg</p>
                            </div>
                            <div className="border-r border-white/10"></div>
                            <div className="text-center">
                                <p className="mb-1">ä¸‹å€‹æª¢æ¸¬é»</p>
                                <p className="text-indigo-300 font-bold">{28 - cycleStats.daysInCycle} å¤©å¾Œ</p>
                            </div>
                        </div>
                        
                        {cycleStats.daysInCycle >= 25 && (
                            <div className="mt-4 p-3 bg-yellow-500/20 border border-yellow-500/50 rounded-lg text-yellow-200 text-xs flex items-start gap-2">
                                <AlertTriangle className="w-4 h-4 flex-shrink-0 mt-0.5" />
                                <div>
                                    <strong>é€±æœŸå³å°‡çµæŸï¼</strong>
                                    <p>å»ºè­°æº–å‚™é‡æ–°è¨ˆç®— TDEEï¼Œä¸¦æ ¹æ“šæœ¬æœˆæˆæ•ˆèª¿æ•´ä¸‹å€‹æœˆçš„ç†±é‡æ”å–ã€‚</p>
                                </div>
                            </div>
                        )}
                    </div>
                )}

                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><FileText className="w-5 h-5 text-emerald-400" /> é£²é£Ÿé€±å ±</h2>
                    <div className="grid grid-cols-2 gap-4 mb-8">
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">å¹³å‡æ”å–ç†±é‡</p><p className="text-2xl font-bold text-white mt-1">{average.cals}</p><p className="text-xs text-slate-500 mt-1">ç›®æ¨™: {profile?.targetCalories}</p></div>
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">å¹³å‡è›‹ç™½è³ª</p><p className="text-2xl font-bold text-blue-400 mt-1">{average.pro}g</p><p className="text-xs text-slate-500 mt-1">ç›®æ¨™: {profile?.protein}g</p></div>
                    </div>
                    <h3 className="text-white font-medium mb-4">è¿‘ 7 å¤©è¶¨å‹¢</h3>
                    <div className="space-y-4 mb-6">
                    {reportData.map((day) => (
                        <div key={day.date} className="bg-slate-700/30 p-3 rounded-lg">
                        <div className="flex justify-between text-sm text-slate-300 mb-2"><span>{day.date}</span><span className={day.cals > profile?.targetCalories ? "text-red-400" : "text-emerald-400"}>{day.cals} kcal</span></div>
                        <div className="w-full h-2 bg-slate-700 rounded-full flex overflow-hidden">
                            <div className="bg-blue-500 h-full" style={{ width: `${(day.pro * 4 / day.cals) * 100}%` }} />
                            <div className="bg-yellow-500 h-full" style={{ width: `${(day.carbs * 4 / day.cals) * 100}%` }} />
                            <div className="bg-red-500 h-full" style={{ width: `${(day.fat * 9 / day.cals) * 100}%` }} />
                        </div>
                        </div>
                    ))}
                    </div>
                    <div className="border-t border-slate-700 pt-6">
                    <button onClick={handleAnalyze} disabled={isAnalyzing || reportData.length === 0} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all disabled:opacity-50">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <MessageSquare className="w-5 h-5" />}{isAnalyzing ? "æ•™ç·´åˆ†æä¸­..." : "âœ¨ AI æ•™ç·´é€±å ±åˆ†æ"}</button>
                    {analysis && <div className="mt-4 bg-slate-900/50 p-4 rounded-xl border border-blue-500/30"><div className="flex items-center gap-2 mb-2 text-blue-400 font-bold"><Sparkles className="w-4 h-4" /> æ•™ç·´å›é¥‹ï¼š</div><div className="text-slate-300 text-sm whitespace-pre-line leading-relaxed">{analysis}</div></div>}
                    </div>
                </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            const [view, setView] = useState('diary');
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isLoggingIn, setIsLoggingIn] = useState(true);
            const [isMobileFit, setIsMobileFit] = useState(false);

            useEffect(() => {
                if (isMobileFit) { document.getElementById('bg-layer')?.classList.add('mobile-fit'); } 
                else { document.getElementById('bg-layer')?.classList.remove('mobile-fit'); }
            }, [isMobileFit]);

            useEffect(() => {
                if (!auth) { setIsLoggingIn(false); return; }
                const unsubscribeAuth = onAuthStateChanged(auth, (u) => { setUser(u); setIsLoggingIn(false); });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const fetchData = async () => {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) { setProfile(docSnap.data()); } else { setView('settings'); }
                    
                    const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                    try {
                        const configSnap = await getDoc(configRef);
                        if (configSnap.exists() && configSnap.data().gemini_api_key) { setApiKey(configSnap.data().gemini_api_key); }
                    } catch(e) {}
                };
                fetchData();
            }, [user]);

            const saveProfile = async (newProfile) => {
                if (!user) return;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), newProfile);
                setProfile(newProfile);
            };

            const handleGoogleLogin = async () => {
                if (!auth) return;
                setIsLoggingIn(true);
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
                catch (error) { console.error("Login failed", error); alert("ç™»å…¥å¤±æ•—"); setIsLoggingIn(false); }
            };

            const handleGuestLogin = async () => {
                if (!auth) return;
                setIsLoggingIn(true);
                try { await signInAnonymously(auth); } catch (error) { setIsLoggingIn(false); }
            };

            const handleLogout = async () => {
                if (!auth) return;
                await signOut(auth);
                setProfile(null);
                setApiKey(DEFAULT_API_KEY);
            };

            if (!app) return <div className="loading">è¨­å®šæœªå®Œæˆï¼Œè«‹æª¢æŸ¥ firebaseConfigã€‚</div>;
            if (isLoggingIn) return <div className="loading">è¼‰å…¥ä¸­...</div>;
            if (!user) return <LoginScreen onGuestLogin={handleGuestLogin} onGoogleLogin={handleGoogleLogin} isLoggingIn={isLoggingIn} />;

            return (
                <div className="min-h-screen text-slate-200 font-sans pb-20 relative">
                <header className="bg-slate-800/80 backdrop-blur-md sticky top-0 z-10 border-b border-slate-700 px-4 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-2"><div className="bg-emerald-500 p-2 rounded-lg"><Activity className="w-5 h-5 text-slate-900" /></div><h1 className="text-xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">IronFuel</h1></div>
                    <div className="flex items-center gap-3">
                    {profile && <div className="text-xs text-right"><p className="text-emerald-400 font-bold">{profile.targetCalories} kcal</p><p className="text-slate-500">{profile.goal === 'cut' ? 'æ¸›è„‚' : 'å¢è‚Œ'}</p></div>}
                    <button onClick={() => setIsMobileFit(!isMobileFit)} className={`p-2 rounded-lg transition-colors ${isMobileFit ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-400 hover:text-white'}`} title="åˆ‡æ›èƒŒæ™¯"><Smartphone className="w-4 h-4" /></button>
                    <button onClick={handleLogout} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-400 hover:text-white transition-colors" title="ç™»å‡º"><LogOut className="w-4 h-4" /></button>
                    </div>
                </header>

                <main className="p-4 max-w-md mx-auto">
                    {view === 'settings' && <SettingsScreen user={user} profile={profile} setProfile={setProfile} hasApiKey={!!apiKey && apiKey.length > 0} onSave={saveProfile} />}
                    {view === 'diary' && profile && <FoodDiary user={user} profile={profile} apiKey={apiKey} />}
                    {view === 'reports' && profile && <Reports user={user} profile={profile} apiKey={apiKey} />}
                    {view === 'inbody' && profile && <InBodyScan user={user} apiKey={apiKey} />}
                </main>

                {profile && <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-4 bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-full shadow-2xl shadow-emerald-900/50 z-40 transition-transform hover:scale-110 active:scale-95"><MessageCircle className="w-6 h-6" /></button>}
                {profile && <AIChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} profile={profile} dayStats={{ cals: 0, pro: 0, carbs: 0, fat: 0 }} apiKey={apiKey} />}

                {profile && (
                    <nav className="fixed bottom-0 left-0 w-full bg-slate-800 border-t border-slate-700 pb-safe z-30">
                    <div className="flex justify-around max-w-md mx-auto">
                        <button onClick={() => setView('settings')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'settings' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><Settings className="w-6 h-6" />è¨­å®š</button>
                        <button onClick={() => setView('diary')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'diary' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><Utensils className="w-6 h-6" />æ—¥è¨˜</button>
                        <button onClick={() => setView('reports')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'reports' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><BarChart3 className="w-6 h-6" />å ±è¡¨</button>
                        <button onClick={() => setView('inbody')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'inbody' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><ScanLine className="w-6 h-6" />InBody</button>
                    </div>
                    </nav>
                )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
