<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronFuel AI Diet Tracker</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 設定 Import Map 以使用模組 -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
      /* --- 關鍵修改：背景圖片設定 --- */
      body { 
        margin: 0;
        padding: 0;
        background-color: #0f172a; 
        color: white;
        
        /* 設定背景圖片 (請確認檔名為 bg.jpg) */
        background-image: url('./bg.jpg');
        background-size: cover;      /* 讓圖片填滿整個螢幕 */
        background-position: center; /* 圖片置中 */
        background-attachment: fixed;/* 捲動時背景固定不動 */
        background-repeat: no-repeat;
      }

      /* --- 關鍵修改：半透明遮罩 --- */
      #root {
        /* 加上 85% 不透明度的深藍色背景，讓文字能清楚浮現在圖片上 */
        background-color: rgba(15, 23, 42, 0.85); 
        min-height: 100vh;
        width: 100%;
      }

      /* 隱藏未載入時的內容 */
      .loading { display: flex; justify-content: center; align-items: center; height: 100vh; color: #10b981; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">正在啟動 IronFuel...</div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calculator, Camera, Utensils, BarChart3, ChevronRight, Plus, Trash2, Save, 
            Calendar as CalendarIcon, Loader2, TrendingDown, Target, Activity, ImagePlus, 
            FileText, Sparkles, ChefHat, MessageSquare, X, PenTool, Scale, MessageCircle, 
            Send, Bot, Key, LogOut, User, LogIn, Settings, Eye, EyeOff, CheckCircle2, 
            AlertTriangle, Copy, Database, Globe, Lock, ChevronDown, ChevronUp
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            GoogleAuthProvider, signInWithPopup, signOut 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, getDoc, addDoc, deleteDoc, 
            onSnapshot, query, orderBy, limit, Timestamp 
        } from 'firebase/firestore';

        // --- 您的 Firebase Config ---
        const manualConfig = {
            apiKey: "AIzaSyA9kVApSCs6eD-u5U90f3dnjbI9TILpaLQ",
            authDomain: "ironfuel-cd5bf.firebaseapp.com",
            projectId: "ironfuel-cd5bf",
            storageBucket: "ironfuel-cd5bf.firebasestorage.app",
            messagingSenderId: "690568494476",
            appId: "1:690568494476:web:5ecda02b96a59d5bc66aa9",
            measurementId: "G-9YS0R1FD5J"
        };

        // --- App ID 設定 ---
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const appId = envAppId || 'ironfuel-app'; 

        // --- Configuration ---
        const DEFAULT_GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const DEFAULT_API_KEY = ""; 

        // --- 初始化 Firebase ---
        let app, auth, db;
        try {
            let finalConfig = null;
            if (typeof __firebase_config !== 'undefined') {
                try {
                    finalConfig = JSON.parse(__firebase_config);
                } catch (e) { console.error(e); }
            }
            if (!finalConfig && Object.keys(manualConfig).length > 0) {
                finalConfig = manualConfig;
            }

            if (finalConfig) {
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } else {
                console.error("尚未設定 Firebase Config");
            }
        } catch (e) {
            console.error("Firebase 初始化失敗:", e);
        }

        // --- Components ---

        const SimpleLineChart = ({ data, color = "#10b981", labelKey = "weight" }) => {
            if (!data || data.length < 2) return (
                <div className="h-40 flex items-center justify-center text-slate-500 text-xs border border-slate-700 border-dashed rounded-lg">
                至少需要兩筆記錄才能顯示趨勢圖
                </div>
            );

            const values = data.map(d => d[labelKey]);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const padding = (max - min) * 0.2 || 1; 
            const graphMin = min - padding;
            const graphMax = max + padding;
            const range = graphMax - graphMin;

            const points = data.map((d, i) => {
                const x = (i / (data.length - 1)) * 100;
                const y = 100 - ((d[labelKey] - graphMin) / range) * 100;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-40 relative mt-4">
                <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <line x1="0" y1="25" x2="100" y2="25" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <line x1="0" y1="50" x2="100" y2="50" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <line x1="0" y1="75" x2="100" y2="75" stroke="#334155" strokeWidth="0.5" strokeDasharray="2" />
                    <polyline fill="none" stroke={color} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                    {data.map((d, i) => {
                    const x = (i / (data.length - 1)) * 100;
                    const y = 100 - ((d[labelKey] - graphMin) / range) * 100;
                    return <circle key={i} cx={x} cy={y} r="1.5" fill="#1e293b" stroke={color} strokeWidth="0.5" vectorEffect="non-scaling-stroke" />;
                    })}
                </svg>
                <div className="absolute top-0 left-0 text-[10px] text-slate-500 -mt-5">{max}kg</div>
                <div className="absolute bottom-0 left-0 text-[10px] text-slate-500 -mb-5">{min}kg</div>
                </div>
            );
        };

        const LoginScreen = ({ onGuestLogin, onGoogleLogin, isLoggingIn }) => {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                {/* 這裡移除 bg-slate-900，讓 body 的背景圖片透出來 */}
                
                <div className="z-10 w-full max-w-md bg-slate-800/90 backdrop-blur-xl p-8 rounded-3xl border border-slate-700 shadow-2xl text-center">
                    <div className="mb-8 flex flex-col items-center">
                    <div className="bg-gradient-to-tr from-emerald-500 to-teal-500 p-4 rounded-2xl shadow-lg mb-4">
                        <Activity className="w-10 h-10 text-white" />
                    </div>
                    <h1 className="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">
                        IronFuel
                    </h1>
                    <p className="text-slate-400 mt-2 text-sm">您的專屬 AI 智能健身營養教練</p>
                    </div>

                    <div className="space-y-4">
                    <button 
                        onClick={onGoogleLogin}
                        disabled={isLoggingIn}
                        className="w-full bg-white hover:bg-slate-100 text-slate-900 py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:scale-100"
                    >
                        {isLoggingIn ? <Loader2 className="w-5 h-5 animate-spin" /> : (
                        <span className="flex items-center gap-2">Google 帳號登入</span>
                        )}
                    </button>

                    <div className="relative flex items-center py-2">
                        <div className="flex-grow border-t border-slate-600"></div>
                        <span className="flex-shrink-0 mx-4 text-slate-500 text-xs">或</span>
                        <div className="flex-grow border-t border-slate-600"></div>
                    </div>

                    <button 
                        onClick={onGuestLogin}
                        disabled={isLoggingIn}
                        className="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95"
                    >
                        <User className="w-5 h-5" />
                        訪客試用 (不保存帳號)
                    </button>
                    </div>
                    
                    <p className="mt-8 text-xs text-slate-500">
                    Fuel your fight, build your steel.
                    </p>
                </div>
                </div>
            );
        };

        const AIChatModal = ({ isOpen, onClose, profile, dayStats, apiKey }) => {
            const [messages, setMessages] = useState([
                { role: 'model', text: '你好！我是你的 AI 健身教練。關於飲食、訓練或營養，有什麼我可以幫你的嗎？' }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, isOpen]);

            const handleSend = async () => {
                if (!input.trim()) return;
                
                const userMessage = { role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                const remaining = {
                cals: profile.targetCalories - dayStats.cals,
                pro: profile.protein - dayStats.pro,
                carbs: profile.carbs - dayStats.carbs,
                fat: profile.fats - dayStats.fat
                };

                try {
                const contextPrompt = `
                    System Context:
                    You are "IronCoach", a friendly and professional fitness nutrition coach.
                    The user's data:
                    - Goal: ${profile.goal === 'cut' ? 'Weight Loss (Cutting)' : 'Muscle Gain (Bulking)'}
                    - Daily Target: ${profile.targetCalories} kcal, ${profile.protein}g Protein.
                    - Today's Status: Consumed ${dayStats.cals} kcal.
                    - Remaining Budget: ${remaining.cals} kcal, ${remaining.pro}g Protein.
                    
                    User Query: ${input}
                    
                    Instruction:
                    Answer the user in Traditional Chinese (繁體中文).
                    Keep the answer concise, encouraging, and practical.
                    If they ask for food recommendations, suggest items that fit their remaining macro budget.
                `;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${apiKey}`,
                    {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: contextPrompt }] }]
                    })
                    }
                );

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "API Error");
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                setMessages(prev => [...prev, { role: 'model', text: text }]);
                } catch (error) {
                console.error("Chat Error", error);
                setMessages(prev => [...prev, { role: 'model', text: `抱歉，連線發生錯誤 (${error.message})。請檢查您的 API Key 設定或網路連線。` }]);
                } finally {
                setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4 animate-in fade-in duration-200">
                <div className="bg-slate-900 w-full max-w-md h-[80vh] rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <div className="bg-gradient-to-tr from-emerald-500 to-teal-500 p-2 rounded-lg">
                        <Bot className="w-5 h-5 text-white" />
                        </div>
                        <div>
                        <h3 className="text-white font-bold">IronCoach</h3>
                        <p className="text-[10px] text-emerald-400">AI 智能教練在線中</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white">
                        <X className="w-6 h-6" />
                    </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900">
                    {messages.map((msg, idx) => (
                        <div 
                        key={idx} 
                        className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                        >
                        <div 
                            className={`max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed ${
                            msg.role === 'user' 
                                ? 'bg-emerald-600 text-white rounded-br-none' 
                                : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-bl-none'
                            }`}
                        >
                            {msg.text}
                        </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="flex justify-start">
                        <div className="bg-slate-800 p-3 rounded-2xl rounded-bl-none border border-slate-700 flex items-center gap-2">
                            <Loader2 className="w-4 h-4 text-emerald-500 animate-spin" />
                            <span className="text-xs text-slate-400">教練正在思考...</span>
                        </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 bg-slate-800 border-t border-slate-700">
                    <div className="flex gap-2">
                        <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                        placeholder="問問教練..."
                        className="flex-1 bg-slate-900 text-white p-3 rounded-xl border border-slate-700 focus:border-emerald-500 outline-none placeholder:text-slate-600"
                        />
                        <button 
                        onClick={handleSend}
                        disabled={isLoading || !input.trim()}
                        className="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:hover:bg-emerald-600 text-white p-3 rounded-xl transition-colors"
                        >
                        <Send className="w-5 h-5" />
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const SettingsScreen = ({ user, profile, setProfile, onSave, hasApiKey }) => {
            const [formData, setFormData] = useState(profile || {
                height: 171, weight: 80, age: 30, gender: 'male', activityLevel: '1.55', goal: 'cut', bodyFat: 21
            });
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState("");
            const [showAdmin, setShowAdmin] = useState(false);

            const calculateTDEE = () => {
                let bmr = (10 * formData.weight) + (6.25 * formData.height) - (5 * formData.age);
                bmr += formData.gender === 'male' ? 5 : -161;
                const tdee = Math.round(bmr * parseFloat(formData.activityLevel));
                let targetCalories = tdee;
                let protein = 0, carbs = 0, fats = 0;

                if (formData.goal === 'cut') {
                targetCalories = tdee - 500;
                protein = Math.round(formData.weight * 2.2);
                fats = Math.round(formData.weight * 0.9);
                } else if (formData.goal === 'bulk') {
                targetCalories = tdee + 300;
                protein = Math.round(formData.weight * 2.0);
                fats = Math.round(formData.weight * 1.0);
                } else {
                protein = Math.round(formData.weight * 1.8);
                fats = Math.round(formData.weight * 1.0);
                }
                const remainingCals = targetCalories - (protein * 4) - (fats * 9);
                carbs = Math.max(0, Math.round(remainingCals / 4));
                
                return { tdee, targetCalories, protein, carbs, fats };
            };

            const results = calculateTDEE();

            const handleSave = async () => {
                setIsSaving(true);
                setSaveMessage("");
                await onSave({ ...formData, ...results });
                setIsSaving(false);
                setSaveMessage("✅ 身體數據已更新！");
                setTimeout(() => setSaveMessage(""), 3000);
            };

            const handleCopy = (text, label) => {
                navigator.clipboard.writeText(text);
                alert(`${label} 已複製！`);
            }

            return (
                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold text-emerald-400 flex items-center gap-2">
                    <Activity className="w-5 h-5" /> 身體數據
                    </h2>
                    {hasApiKey ? (
                    <div className="flex items-center gap-1.5 px-3 py-1 bg-emerald-900/30 rounded-full border border-emerald-500/30">
                        <div className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                        <span className="text-[10px] text-emerald-300 font-medium">AI 已連線</span>
                    </div>
                    ) : (
                    <div className="flex items-center gap-1.5 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
                        <div className="w-2 h-2 rounded-full bg-slate-500"></div>
                        <span className="text-[10px] text-slate-400 font-medium">AI 離線</span>
                    </div>
                    )}
                </div>

                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                    <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="text-slate-400 text-xs uppercase tracking-wider">身高 (cm)</label>
                        <input type="number" value={formData.height} onChange={(e) => setFormData({...formData, height: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" />
                    </div>
                    <div>
                        <label className="text-slate-400 text-xs uppercase tracking-wider">體重 (kg)</label>
                        <input type="number" value={formData.weight} onChange={(e) => setFormData({...formData, weight: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" />
                    </div>
                    <div>
                        <label className="text-slate-400 text-xs uppercase tracking-wider">年齡</label>
                        <input type="number" value={formData.age} onChange={(e) => setFormData({...formData, age: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" />
                    </div>
                    <div>
                        <label className="text-slate-400 text-xs uppercase tracking-wider">體脂率 (%)</label>
                        <input type="number" value={formData.bodyFat} onChange={(e) => setFormData({...formData, bodyFat: Number(e.target.value)})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none" />
                    </div>
                    </div>
                    <div className="mt-4">
                    <label className="text-slate-400 text-xs uppercase tracking-wider">活動量</label>
                    <select value={formData.activityLevel} onChange={(e) => setFormData({...formData, activityLevel: e.target.value})} className="w-full bg-slate-700 text-white p-3 rounded-lg mt-1 focus:ring-2 focus:ring-emerald-500 outline-none">
                        <option value="1.2">久坐不動</option>
                        <option value="1.375">輕度活動 (1-3天)</option>
                        <option value="1.55">中度活動 (3-5天)</option>
                        <option value="1.725">高度活動 (6-7天)</option>
                    </select>
                    </div>
                    <div className="mt-4">
                    <label className="text-slate-400 text-xs uppercase tracking-wider">目標</label>
                    <div className="flex gap-2 mt-1">
                        {['cut', 'maintain', 'bulk'].map(mode => (
                        <button key={mode} onClick={() => setFormData({...formData, goal: mode})} className={`flex-1 py-2 px-4 rounded-lg text-sm font-semibold transition-colors ${formData.goal === mode ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>
                            {mode === 'cut' ? '減脂' : mode === 'maintain' ? '維持' : '增肌'}
                        </button>
                        ))}
                    </div>
                    </div>
                </div>

                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-10">
                    <Target className="w-24 h-24 text-emerald-400" />
                    </div>
                    <h3 className="text-lg font-semibold text-white mb-4">預覽：每日營養目標</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-slate-900/50 p-3 rounded-xl">
                        <p className="text-slate-400 text-xs">目標熱量</p>
                        <p className="text-2xl font-bold text-emerald-400">{results.targetCalories}</p>
                        <p className="text-xs text-slate-500">kcal</p>
                    </div>
                    <div className="bg-slate-900/50 p-3 rounded-xl">
                        <p className="text-slate-400 text-xs">蛋白質</p>
                        <p className="text-xl font-bold text-blue-400">{results.protein}g</p>
                        <p className="text-xs text-slate-500">高蛋白保肌</p>
                    </div>
                    <div className="bg-slate-900/50 p-3 rounded-xl">
                        <p className="text-slate-400 text-xs">碳水化合物</p>
                        <p className="text-xl font-bold text-yellow-400">{results.carbs}g</p>
                        <p className="text-xs text-slate-500">訓練燃料</p>
                    </div>
                    <div className="bg-slate-900/50 p-3 rounded-xl">
                        <p className="text-slate-400 text-xs">脂肪</p>
                        <p className="text-xl font-bold text-red-400">{results.fats}g</p>
                        <p className="text-xs text-slate-500">荷爾蒙維持</p>
                    </div>
                    </div>
                    <button 
                    onClick={handleSave} 
                    disabled={isSaving}
                    className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-800 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-900/20"
                    >
                    {isSaving ? <Loader2 className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
                    {isSaving ? "正在儲存..." : "儲存設定並開始"}
                    </button>
                    {saveMessage && (
                    <div className="mt-3 p-3 bg-emerald-500/20 border border-emerald-500/50 rounded-lg flex items-center gap-2 text-emerald-400 text-sm justify-center animate-in fade-in slide-in-from-bottom-2">
                        <CheckCircle2 className="w-4 h-4" /> {saveMessage}
                    </div>
                    )}
                </div>

                <div className="pt-8 border-t border-slate-800/50 text-center">
                    <button 
                    onClick={() => setShowAdmin(!showAdmin)}
                    className="text-[10px] text-slate-700 hover:text-slate-500 transition-colors flex items-center justify-center gap-1 mx-auto"
                    >
                    {showAdmin ? <ChevronUp className="w-3 h-3" /> : <Lock className="w-3 h-3" />}
                    {showAdmin ? "隱藏管理設定" : "管理員設置 (Admin Only)"}
                    </button>

                    {showAdmin && (
                    <div className="mt-6 text-left bg-slate-900 p-4 rounded-xl border border-slate-700 animate-in slide-in-from-bottom-4">
                        <div className="flex items-center gap-2 mb-3 text-yellow-500">
                        <Database className="w-4 h-4" />
                        <span className="font-bold text-sm">Firebase 連線資訊</span>
                        </div>
                        
                        <div className="text-xs text-slate-500 mb-4 space-y-2">
                        <p>請確認您的 API Key 位於以下 Firebase 路徑 (點擊複製 App ID):</p>
                        <div className="bg-black/30 p-2 rounded font-mono text-emerald-400 break-all">
                            artifacts / {appId} / public / data / config / settings
                        </div>
                        <p className="italic text-slate-600">欄位: gemini_api_key (String)</p>
                        </div>

                        <div className="space-y-2">
                        <div>
                            <label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">App ID</label>
                            <div className="flex gap-2 mt-1">
                            <code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">
                                {appId}
                            </code>
                            <button onClick={() => handleCopy(appId, "App ID")} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button>
                            </div>
                        </div>
                        <div>
                            <label className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">User ID</label>
                            <div className="flex gap-2 mt-1">
                            <code className="flex-1 bg-black/30 text-slate-400 p-2 rounded text-xs font-mono truncate">
                                {user.uid}
                            </code>
                            <button onClick={() => handleCopy(user.uid, "User ID")} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded"><Copy className="w-3 h-3" /></button>
                            </div>
                        </div>
                        </div>
                    </div>
                    )}
                </div>
                </div>
            );
        };

        const FoodDiary = ({ user, profile, apiKey }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [logs, setLogs] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isSuggesting, setIsSuggesting] = useState(false);
            const [suggestion, setSuggestion] = useState(null);
            const [isManualOpen, setIsManualOpen] = useState(false);
            const [manualData, setManualData] = useState({
                name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: ''
            });

            const fileInputRef = useRef(null);
            
            const [dayStats, setDayStats] = useState({ cals: 0, pro: 0, carbs: 0, fat: 0 });

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const allLogs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                const todaysLogs = allLogs.filter(log => log.date === date);
                setLogs(todaysLogs);

                const stats = todaysLogs.reduce((acc, curr) => ({
                    cals: acc.cals + (curr.calories || 0),
                    pro: acc.pro + (curr.protein || 0),
                    carbs: acc.carbs + (curr.carbs || 0),
                    fat: acc.fat + (curr.fat || 0),
                }), { cals: 0, pro: 0, carbs: 0, fat: 0 });
                setDayStats(stats);
                });

                return () => unsubscribe();
            }, [user, date]);

            const handleManualSubmit = async () => {
                if (!manualData.name || !manualData.calories) return;
                
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), {
                name: manualData.name,
                mealType: manualData.mealType,
                calories: Number(manualData.calories),
                protein: Number(manualData.protein) || 0,
                carbs: Number(manualData.carbs) || 0,
                fat: Number(manualData.fat) || 0,
                date: date,
                timestamp: new Date().toISOString()
                });
                
                setIsManualOpen(false);
                setManualData({ name: '', mealType: 'lunch', calories: '', protein: '', carbs: '', fat: '' });
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!apiKey) {
                alert("AI 功能尚未啟用，請通知管理員檢查後台設定。");
                return;
                }

                setIsAnalyzing(true);

                try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1];
                    const mimeType = file.type;

                    const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                        contents: [{
                            parts: [
                            { text: "Analyze this food image. Identify the food item and estimate its nutritional values (Calories, Protein, Carbs, Fat) for the visible portion. Return ONLY a valid JSON object with this structure: { \"name\": \"Food Name\", \"calories\": number, \"protein\": number, \"carbs\": number, \"fat\": number, \"note\": \"Brief explanation\" }. Do not use markdown." },
                            { inlineData: { mimeType: mimeType, data: base64Data } }
                            ]
                        }]
                        })
                    }
                    );

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || "AI Analysis Error");
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    let jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const foodData = JSON.parse(jsonStr);

                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), {
                    ...foodData,
                    mealType: 'auto',
                    date: date,
                    timestamp: new Date().toISOString()
                    });
                    setIsAnalyzing(false);
                };
                } catch (error) {
                console.error("AI Error:", error);
                alert(`AI 分析失敗: ${error.message}，請檢查 Key 是否有權限或模型名稱是否正確。`);
                setIsAnalyzing(false);
                }
            };

            const deleteLog = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'logs', id));
            };

            const getMealSuggestion = async () => {
                if (!apiKey) {
                alert("AI 功能尚未啟用，請通知管理員檢查後台設定。");
                return;
                }

                setIsSuggesting(true);
                setSuggestion(null);

                const remaining = {
                cals: profile.targetCalories - dayStats.cals,
                pro: profile.protein - dayStats.pro,
                carbs: profile.carbs - dayStats.carbs,
                fat: profile.fats - dayStats.fat
                };

                try {
                const prompt = `
                    我是一名健身教練。我的學生今天還剩下以下營養額度：
                    熱量: ${remaining.cals} kcal, 蛋白質: ${remaining.pro}g, 碳水: ${remaining.carbs}g, 脂肪: ${remaining.fat}g。
                    他的目標是：${profile.goal === 'cut' ? '減脂' : '增肌'}。
                    請為他建議「單一餐點」（午餐或晚餐），必須符合且填滿剩下的蛋白質目標，但不要超過熱量上限。
                    請提供繁體中文的建議。
                    Return ONLY a valid JSON object: { "mealName": "名稱", "reason": "推薦理由", "ingredients": "食材清單", "estimatedNutrition": "預估熱量與三大營養素" }
                `;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${apiKey}`,
                    {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                    }
                );

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "AI Suggestion Error");
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                setSuggestion(JSON.parse(jsonStr));
                } catch (error) {
                console.error("Suggestion Error", error);
                alert(`AI 思考超時: ${error.message}，請檢查 Key 是否有權限或模型名稱是否正確。`);
                } finally {
                setIsSuggesting(false);
                }
            };

            const Progress = ({ current, target, color }) => {
                const pct = Math.min((current / target) * 100, 100);
                return (
                <div className="w-full bg-slate-700 rounded-full h-2 mt-1">
                    <div className={`h-2 rounded-full ${color} transition-all duration-500`} style={{ width: `${pct}%` }} />
                </div>
                );
            };

            return (
                <div className="space-y-6">
                <div className="flex items-center justify-between bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() - 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5 rotate-180 text-slate-400"/></button>
                    <div className="flex items-center gap-2 text-white font-medium"><CalendarIcon className="w-5 h-5 text-emerald-500" />{date}</div>
                    <button className="p-2 hover:bg-slate-700 rounded-lg" onClick={() => { const d = new Date(date); d.setDate(d.getDate() + 1); setDate(d.toISOString().split('T')[0]); }}><ChevronRight className="w-5 h-5 text-slate-400"/></button>
                </div>

                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <div className="flex justify-between items-end mb-4">
                    <div>
                        <h3 className="text-slate-400 text-sm">今日熱量</h3>
                        <div className="flex items-baseline gap-2"><span className="text-3xl font-bold text-white">{dayStats.cals}</span><span className="text-sm text-slate-500">/ {profile?.targetCalories} kcal</span></div>
                    </div>
                    <div className="text-right"><span className={`text-sm font-bold ${profile?.targetCalories - dayStats.cals >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{profile?.targetCalories - dayStats.cals >= 0 ? '剩餘' : '超標'} {Math.abs(profile?.targetCalories - dayStats.cals)}</span></div>
                    </div>
                    <Progress current={dayStats.cals} target={profile?.targetCalories} color="bg-emerald-500" />
                    <div className="grid grid-cols-3 gap-4 mt-6">
                    <div className="text-center"><p className="text-xs text-slate-400 mb-1">蛋白質</p><p className="text-lg font-bold text-blue-400">{dayStats.pro}g</p><p className="text-[10px] text-slate-500">目標 {profile?.protein}g</p><Progress current={dayStats.pro} target={profile?.protein} color="bg-blue-500" /></div>
                    <div className="text-center"><p className="text-xs text-slate-400 mb-1">碳水</p><p className="text-lg font-bold text-yellow-400">{dayStats.carbs}g</p><p className="text-[10px] text-slate-500">目標 {profile?.carbs}g</p><Progress current={dayStats.carbs} target={profile?.carbs} color="bg-yellow-500" /></div>
                    <div className="text-center"><p className="text-xs text-slate-400 mb-1">脂肪</p><p className="text-lg font-bold text-red-400">{dayStats.fat}g</p><p className="text-[10px] text-slate-500">目標 {profile?.fats}g</p><Progress current={dayStats.fat} target={profile?.fats} color="bg-red-500" /></div>
                    </div>
                </div>

                {suggestion && (
                    <div className="bg-gradient-to-br from-indigo-900 to-slate-900 p-5 rounded-2xl border border-indigo-500/50 relative animate-in slide-in-from-top-4">
                    <button onClick={() => setSuggestion(null)} className="absolute top-3 right-3 text-slate-400 hover:text-white"><X className="w-5 h-5" /></button>
                    <div className="flex items-center gap-2 mb-3"><Sparkles className="w-5 h-5 text-indigo-400" /><h3 className="font-bold text-white">AI 智能餐點建議</h3></div>
                    <h4 className="text-xl font-bold text-indigo-300 mb-2">{suggestion.mealName}</h4>
                    <p className="text-slate-300 text-sm mb-3">{suggestion.reason}</p>
                    <div className="bg-black/30 p-3 rounded-lg text-sm text-slate-300 mb-3"><strong>建議食材：</strong> {suggestion.ingredients}</div>
                    <div className="text-xs text-indigo-400 font-mono">{suggestion.estimatedNutrition}</div>
                    </div>
                )}

                {isManualOpen && (
                    <div className="bg-slate-800 p-5 rounded-2xl border border-slate-600 animate-in slide-in-from-top-2">
                    <div className="flex justify-between items-center mb-4"><h3 className="text-white font-bold flex items-center gap-2"><PenTool className="w-5 h-5 text-emerald-400" /> 手動輸入餐點</h3><button onClick={() => setIsManualOpen(false)} className="text-slate-400 hover:text-white"><X className="w-5 h-5" /></button></div>
                    <div className="space-y-4">
                        <div><label className="text-xs text-slate-400 block mb-1">餐點名稱</label><input type="text" placeholder="例如：雞胸肉沙拉" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 focus:border-emerald-500 outline-none" value={manualData.name} onChange={e => setManualData({...manualData, name: e.target.value})} /></div>
                        <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs text-slate-400 block mb-1">用餐時段</label><select className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.mealType} onChange={e => setManualData({...manualData, mealType: e.target.value})}><option value="breakfast">早餐</option><option value="lunch">午餐</option><option value="dinner">晚餐</option><option value="snack">點心/額外</option></select></div>
                        <div><label className="text-xs text-slate-400 block mb-1">熱量 (kcal)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.calories} onChange={e => setManualData({...manualData, calories: e.target.value})} /></div>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                        <div><label className="text-xs text-slate-400 block mb-1">蛋白質 (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.protein} onChange={e => setManualData({...manualData, protein: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">碳水 (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.carbs} onChange={e => setManualData({...manualData, carbs: e.target.value})} /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">脂肪 (g)</label><input type="number" placeholder="0" className="w-full bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={manualData.fat} onChange={e => setManualData({...manualData, fat: e.target.value})} /></div>
                        </div>
                        <button onClick={handleManualSubmit} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold mt-2">加入日記</button>
                    </div>
                    </div>
                )}

                {!isManualOpen && (
                    <div className="grid grid-cols-3 gap-2">
                    <button onClick={() => setIsManualOpen(true)} className="bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all"><PenTool className="w-5 h-5 text-emerald-400" /><span className="text-xs">手動輸入</span></button>
                    <button onClick={() => fileInputRef.current.click()} disabled={isAnalyzing} className="bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <Camera className="w-5 h-5 text-blue-400" />}<span className="text-xs">{isAnalyzing ? "分析中..." : "拍照記錄"}</span></button>
                    <button onClick={getMealSuggestion} disabled={isSuggesting} className="bg-gradient-to-br from-indigo-600 to-purple-700 hover:from-indigo-500 hover:to-purple-600 text-white py-4 rounded-xl font-bold flex flex-col items-center justify-center gap-1 shadow-lg transition-all">{isSuggesting ? <Loader2 className="w-5 h-5 animate-spin" /> : <ChefHat className="w-5 h-5 text-yellow-300" />}<span className="text-xs">{isSuggesting ? "思考中..." : "AI 建議"}</span></button>
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                    </div>
                )}

                <div className="space-y-3 pb-20">
                    <h3 className="text-white font-semibold text-lg flex items-center gap-2"><Utensils className="w-5 h-5 text-slate-400" /> 今日餐點</h3>
                    {logs.length === 0 ? <div className="text-center p-8 border-2 border-dashed border-slate-700 rounded-xl"><p className="text-slate-500">今天還沒紀錄喔！</p></div> : 
                    logs.map((log) => (
                        <div key={log.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center group">
                        <div>
                            <div className="flex items-center gap-2"><h4 className="text-white font-medium text-lg">{log.name}</h4>{log.mealType && <span className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full uppercase">{log.mealType === 'breakfast' ? '早餐' : log.mealType === 'lunch' ? '午餐' : log.mealType === 'dinner' ? '晚餐' : log.mealType === 'snack' ? '點心' : '自動'}</span>}</div>
                            <div className="flex gap-3 text-sm text-slate-400 mt-1"><span className="text-emerald-400 font-bold">{log.calories} kcal</span><span>P: {log.protein}g</span><span>C: {log.carbs}g</span><span>F: {log.fat}g</span></div>
                            {log.note && <p className="text-xs text-slate-500 mt-1 italic">{log.note}</p>}
                        </div>
                        <button onClick={() => deleteLog(log.id)} className="p-2 text-slate-600 hover:text-red-400 hover:bg-slate-700 rounded-full transition-colors"><Trash2 className="w-5 h-5" /></button>
                        </div>
                    ))
                    }
                </div>
                </div>
            );
        };

        const Reports = ({ user, profile, apiKey }) => {
            const [reportData, setReportData] = useState([]);
            const [average, setAverage] = useState({ cals: 0, pro: 0 });
            const [analysis, setAnalysis] = useState("");
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [weightLogs, setWeightLogs] = useState([]);
            const [currentWeight, setCurrentWeight] = useState("");

            useEffect(() => {
                if(!user) return;
                const qLogs = query(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), orderBy('date', 'desc'));
                const unsubscribeLogs = onSnapshot(qLogs, (snapshot) => {
                const allLogs = snapshot.docs.map(d => d.data());
                const grouped = allLogs.reduce((acc, curr) => {
                    if (!acc[curr.date]) { acc[curr.date] = { date: curr.date, cals: 0, pro: 0, carbs: 0, fat: 0 }; }
                    acc[curr.date].cals += (curr.calories || 0);
                    acc[curr.date].pro += (curr.protein || 0);
                    acc[curr.date].carbs += (curr.carbs || 0);
                    acc[curr.date].fat += (curr.fat || 0);
                    return acc;
                }, {});
                const sortedDays = Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-7);
                setReportData(sortedDays);
                if (sortedDays.length > 0) {
                    const totalCals = sortedDays.reduce((sum, d) => sum + d.cals, 0);
                    const totalPro = sortedDays.reduce((sum, d) => sum + d.pro, 0);
                    setAverage({ cals: Math.round(totalCals / sortedDays.length), pro: Math.round(totalPro / sortedDays.length) });
                }
                });
                const qWeight = query(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), orderBy('date', 'asc'));
                const unsubscribeWeight = onSnapshot(qWeight, (snapshot) => { const wLogs = snapshot.docs.map(d => d.data()); setWeightLogs(wLogs); });
                return () => { unsubscribeLogs(); unsubscribeWeight(); };
            }, [user]);

            const handleAddWeight = async () => {
                if (!currentWeight) return;
                const today = new Date().toISOString().split('T')[0];
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'weight_logs'), { date: today, weight: Number(currentWeight), timestamp: new Date().toISOString() });
                setCurrentWeight("");
            };

            const handleAnalyze = async () => {
                if (reportData.length === 0) return;
                if (!apiKey) { alert("AI 功能尚未啟用，請通知管理員檢查後台設定。"); return; }
                setIsAnalyzing(true);
                setAnalysis("");
                try {
                const prompt = `
                    你是一位專業的運動營養教練。請分析學生過去 7 天的飲食數據：
                    ${JSON.stringify(reportData)}
                    體重紀錄：${JSON.stringify(weightLogs.slice(-5))}
                    他的目標是：${profile.goal === 'cut' ? '減脂' : '增肌'}。
                    每日目標：熱量 ${profile.targetCalories}, 蛋白質 ${profile.protein}g。
                    請用繁體中文給出 3 點簡短的分析與建議。語氣要專業、鼓勵，並指出具體可以改進的地方（例如週末是否鬆懈了？蛋白質是否穩定達標？體重趨勢如何？）。
                    直接輸出文字即可，不需要 JSON。
                `;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "AI Analysis Error");
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                setAnalysis(text);
                } catch (error) { 
                    console.error("Analysis Error", error); 
                    alert(`AI 思考超時: ${error.message}，請檢查 Key 是否有權限或模型名稱是否正確。`); 
                } finally { setIsAnalyzing(false); }
            };

            return (
                <div className="space-y-6">
                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Scale className="w-5 h-5 text-emerald-400" /> 體重追蹤</h2>
                    <div className="flex gap-2 mb-4">
                    <input type="number" placeholder="今日體重 (kg)" className="flex-1 bg-slate-900 text-white p-3 rounded-lg border border-slate-700 outline-none" value={currentWeight} onChange={(e) => setCurrentWeight(e.target.value)} />
                    <button onClick={handleAddWeight} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded-lg font-bold">記錄</button>
                    </div>
                    <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 min-h-[200px]">
                    <h3 className="text-xs text-slate-400 mb-2">近期體重趨勢</h3>
                    <SimpleLineChart data={weightLogs} />
                    </div>
                </div>

                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><FileText className="w-5 h-5 text-emerald-400" /> 飲食週報</h2>
                    <div className="grid grid-cols-2 gap-4 mb-8">
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">平均攝取熱量</p><p className="text-2xl font-bold text-white mt-1">{average.cals}</p><p className="text-xs text-slate-500 mt-1">目標: {profile?.targetCalories}</p></div>
                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><p className="text-slate-400 text-sm">平均蛋白質</p><p className="text-2xl font-bold text-blue-400 mt-1">{average.pro}g</p><p className="text-xs text-slate-500 mt-1">目標: {profile?.protein}g</p></div>
                    </div>
                    <h3 className="text-white font-medium mb-4">近 7 天趨勢</h3>
                    <div className="space-y-4 mb-6">
                    {reportData.map((day) => (
                        <div key={day.date} className="bg-slate-700/30 p-3 rounded-lg">
                        <div className="flex justify-between text-sm text-slate-300 mb-2"><span>{day.date}</span><span className={day.cals > profile?.targetCalories ? "text-red-400" : "text-emerald-400"}>{day.cals} kcal</span></div>
                        <div className="w-full h-2 bg-slate-700 rounded-full flex overflow-hidden">
                            <div className="bg-blue-500 h-full" style={{ width: `${(day.pro * 4 / day.cals) * 100}%` }} title="Protein" />
                            <div className="bg-yellow-500 h-full" style={{ width: `${(day.carbs * 4 / day.cals) * 100}%` }} title="Carbs" />
                            <div className="bg-red-500 h-full" style={{ width: `${(day.fat * 9 / day.cals) * 100}%` }} title="Fat" />
                        </div>
                        </div>
                    ))}
                    </div>
                    <div className="border-t border-slate-700 pt-6">
                    <button onClick={handleAnalyze} disabled={isAnalyzing || reportData.length === 0} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all disabled:opacity-50">{isAnalyzing ? <Loader2 className="w-5 h-5 animate-spin" /> : <MessageSquare className="w-5 h-5" />}{isAnalyzing ? "教練分析中..." : "✨ AI 教練週報分析"}</button>
                    {analysis && <div className="mt-4 bg-slate-900/50 p-4 rounded-xl border border-blue-500/30"><div className="flex items-center gap-2 mb-2 text-blue-400 font-bold"><Sparkles className="w-4 h-4" /> 教練回饋：</div><div className="text-slate-300 text-sm whitespace-pre-line leading-relaxed">{analysis}</div></div>}
                    </div>
                </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [apiKey, setApiKey] = useState(DEFAULT_API_KEY);
            const [view, setView] = useState('diary');
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [isLoggingIn, setIsLoggingIn] = useState(true);

            useEffect(() => {
                if (!auth) {
                    setIsLoggingIn(false);
                    return;
                }
                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsLoggingIn(false);
                });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const fetchData = async () => {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) { setProfile(docSnap.data()); } else { setView('settings'); }
                    
                    const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                    try {
                        const configSnap = await getDoc(configRef);
                        if (configSnap.exists() && configSnap.data().gemini_api_key) { 
                            setApiKey(configSnap.data().gemini_api_key); 
                        }
                    } catch(e) {
                        console.error("無法讀取全域設定，可能是權限不足", e);
                    }
                };
                fetchData();
            }, [user]);

            const saveProfile = async (newProfile) => {
                if (!user) return;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), newProfile);
                setProfile(newProfile);
            };

            const handleGoogleLogin = async () => {
                if (!auth) return;
                setIsLoggingIn(true);
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login failed", error);
                    alert("登入失敗，請檢查 console 錯誤訊息 (通常是 Firebase Config 設定問題)。");
                    setIsLoggingIn(false);
                }
            };

            const handleGuestLogin = async () => {
                if (!auth) return;
                setIsLoggingIn(true);
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Guest login failed", error);
                    setIsLoggingIn(false);
                }
            };

            const handleLogout = async () => {
                if (!auth) return;
                await signOut(auth);
                setProfile(null);
                setApiKey(DEFAULT_API_KEY);
            };

            // 如果 Firebase 沒初始化成功 (因為 Config 空白)，顯示錯誤畫面
            if (!app) {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
                        <div className="bg-red-500/20 p-6 rounded-2xl border border-red-500 max-w-md">
                            <h2 className="text-xl font-bold text-red-400 mb-2">⚠️ 設定未完成</h2>
                            <p className="text-slate-300 mb-4">
                                您尚未填入 Firebase 設定檔。
                            </p>
                            <p className="text-sm text-slate-400 mb-4 text-left">
                                請用記事本打開 <code>index.html</code>，找到約第 35 行的 <code>const firebaseConfig</code>，並填入您的 Firebase 專案資訊 (apiKey, authDomain 等)。
                            </p>
                            <a href="https://console.firebase.google.com/" target="_blank" className="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm transition-colors inline-block">
                                前往 Firebase Console 取得設定
                            </a>
                        </div>
                    </div>
                );
            }

            if (isLoggingIn) {
                return <div className="loading">載入中...</div>;
            }

            if (!user) {
                return <LoginScreen onGuestLogin={handleGuestLogin} onGoogleLogin={handleGoogleLogin} isLoggingIn={isLoggingIn} />;
            }

            return (
                <div className="min-h-screen text-slate-200 font-sans pb-20 relative">
                <header className="bg-slate-800/80 backdrop-blur-md sticky top-0 z-10 border-b border-slate-700 px-4 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-2"><div className="bg-emerald-500 p-2 rounded-lg"><Activity className="w-5 h-5 text-slate-900" /></div><h1 className="text-xl font-bold bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">IronFuel</h1></div>
                    <div className="flex items-center gap-3">
                    {profile && <div className="text-xs text-right"><p className="text-emerald-400 font-bold">{profile.targetCalories} kcal</p><p className="text-slate-500">{profile.goal === 'cut' ? '減脂' : '增肌'}</p></div>}
                    <button onClick={handleLogout} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-400 hover:text-white transition-colors" title="登出"><LogOut className="w-4 h-4" /></button>
                    </div>
                </header>

                <main className="p-4 max-w-md mx-auto">
                    {view === 'settings' && <SettingsScreen user={user} profile={profile} setProfile={setProfile} hasApiKey={!!apiKey && apiKey.length > 0} onSave={saveProfile} />}
                    {view === 'diary' && profile && <FoodDiary user={user} profile={profile} apiKey={apiKey} />}
                    {view === 'reports' && profile && <Reports user={user} profile={profile} apiKey={apiKey} />}
                </main>

                {profile && <button onClick={() => setIsChatOpen(true)} className="fixed bottom-24 right-4 bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-full shadow-2xl shadow-emerald-900/50 z-40 transition-transform hover:scale-110 active:scale-95"><MessageCircle className="w-6 h-6" /></button>}
                {profile && <AIChatModal isOpen={isChatOpen} onClose={() => setIsChatOpen(false)} profile={profile} dayStats={{ cals: 0, pro: 0, carbs: 0, fat: 0 }} apiKey={apiKey} />}

                {profile && (
                    <nav className="fixed bottom-0 left-0 w-full bg-slate-800 border-t border-slate-700 pb-safe z-30">
                    <div className="flex justify-around max-w-md mx-auto">
                        <button onClick={() => setView('settings')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'settings' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><Settings className="w-6 h-6" />設定</button>
                        <button onClick={() => setView('diary')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'diary' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><Utensils className="w-6 h-6" />日記</button>
                        <button onClick={() => setView('reports')} className={`p-4 flex flex-col items-center gap-1 text-xs font-medium transition-colors ${view === 'reports' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}><BarChart3 className="w-6 h-6" />報表</button>
                    </div>
                    </nav>
                )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
